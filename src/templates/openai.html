<!-- ==================== OpenApi 管理部分 ==================== -->
<div class="tab-content openai-tab-content theme-openai" :class="getTabAnimationClass('openai')">
  <!-- OpenApi 子标签页 -->
  <div class="sec-tabs openai-sec-tabs">
    <button class="tab-btn" :class="{ active: openaiCurrentTab === 'endpoints' }"
      @click="openaiCurrentTab = 'endpoints'">
      <i class="fas fa-server"></i> API 端点
    </button>
    <button class="tab-btn" :class="{ active: openaiCurrentTab === 'accounts' }" @click="openaiCurrentTab = 'accounts'">
      <i class="fas fa-users"></i> 账号管理
    </button>
    <button class="tab-btn" :class="{ active: openaiCurrentTab === 'chat' }" @click="openaiCurrentTab = 'chat'">
      <i class="fas fa-comment-dots"></i> 对话
    </button>
  </div>

  <!-- API 端点标签页 -->
  <div v-if="openaiCurrentTab === 'endpoints'" class="sub-tab-content quick-fade-in">
    <div v-if="openaiLoading" class="loading">
      <div class="spinner"></div>
      <div style="margin-top: 12px">加载中...</div>
    </div>

    <template v-else>
      <!-- 顶部操作栏 -->
      <div class="endpoints-toolbar">
        <div class="toolbar-left">
          <span class="toolbar-title" v-if="!openaiModelHealthBatchLoading">共 {{ openaiEndpoints.length }} 个端点</span>
          <div class="toolbar-progress" v-else>
            <i class="fas fa-circle-notch fa-spin"></i>
            <span>正在批量检测模型可用性...</span>
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-primary btn-sm" @click="openaiHealthCheckModal = true">
            <i class="fas fa-heartbeat"></i> <span>健康检测</span>
          </button>
          <button class="btn btn-secondary btn-sm" @click="refreshAllOpenaiEndpoints" :disabled="openaiRefreshing">
            <i class="fas fa-sync-alt" :class="{ 'fa-spin': openaiRefreshing }"></i> <span>刷新列表</span>
          </button>
        </div>
      </div>

      <!-- 端点卡片列表 -->
      <div>
        <div v-for="endpoint in openaiEndpoints" :key="endpoint.id" class="account-card"
          :class="{ 'expanded': isOpenaiEndpointExpanded(endpoint.id) }" style="margin-bottom: 12px">
          <!-- 端点头部 - 可点击展开模型列表 -->
          <div class="account-header" @click="toggleOpenaiModels(endpoint.id)">
            <div class="account-info">
              <i class="fas fa-chevron-right toggle-icon" :style="{
              transform: isOpenaiEndpointExpanded(endpoint.id) ? 'rotate(90deg)' : 'rotate(0deg)'
            }"></i>
              <!-- 头像 -->
              <div class="zeabur-account-avatar" style="background: linear-gradient(135deg, #10a37f, #059669)">
                <span class="avatar-letter">{{ (endpoint.name || 'A').charAt(0).toUpperCase() }}</span>
              </div>
              <!-- 端点信息 -->
              <div class="zeabur-account-details">
                <div class="zeabur-account-name">
                  <span class="ag-status-badge" style="margin-right: 8px; font-size: 10px"
                    :class="endpoint.status === 'valid' ? 'ag-status-online' : (endpoint.status === 'invalid' ? 'ag-status-error' : 'ag-status-unknown')">
                    {{ endpoint.status === 'valid' ? '有效' : (endpoint.status === 'invalid' ? '无效'
                    : '未验证') }}
                  </span>
                  {{ endpoint.name || '未命名端点' }}
                </div>
                <div class="zeabur-account-email">
                  <i class="fas fa-link"></i>
                  {{ maskAddress(endpoint.baseUrl, serverIpDisplayMode) }}
                </div>
              </div>
            </div>
            <!-- 模型数量及健康检测操作 -->
            <div class="endpoint-badges">
              <!-- 健康检测按钮 -->
              <div class="endpoint-action-btn btn-health" v-if="endpoint.models"
                @click.stop="openHealthCheckForEndpoint(endpoint.id)" title="对该端点进行模型健康检测">
                <i class="fas fa-heartbeat"></i>
              </div>
              
              <!-- 模型数量/刷新按钮 -->
              <div class="endpoint-action-btn btn-models" v-if="endpoint.models" 
                @click.stop="refreshEndpointModels(endpoint)"
                :title="endpoint.refreshing ? '正在刷新...' : '点击刷新模型列表'">
                <i class="fas fa-cube" :class="{ 'refreshing': endpoint.refreshing }"></i>
                <div class="action-info">
                  <span class="label">模型</span>
                  <span class="value">{{ endpoint.models.length }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="account-card-body">
            <!-- 模型列表 - 可展开/收起 -->
            <div class="openai-models-container" :class="{ 'collapsed': !isOpenaiEndpointExpanded(endpoint.id) }">
              <div v-if="endpoint.models && endpoint.models.length > 0" class="models-grid">
                <div v-for="model in endpoint.models" :key="getModelName(model)" class="model-tag-item"
                  :class="{ 'has-health': openaiModelHealth[getModelName(model)] }"
                  :title="'点击进入对话: ' + getModelName(model)">
                  <div v-if="openaiModelHealth[getModelName(model)] || openaiModelHealthBatchLoading"
                    class="model-health-indicator"
                    :class="[openaiModelHealth[getModelName(model)]?.status || 'unknown', { 'is-health-loading': openaiModelHealth[getModelName(model)]?.loading }]"
                    @click.stop="testModelHealth({id: getModelName(model)})"
                    :title="openaiModelHealth[getModelName(model)] ? ('检测时间: ' + formatDateTime(openaiModelHealth[getModelName(model)].checkedAt) + '\n延迟: ' + (openaiModelHealth[getModelName(model)].latency || '-') + 'ms') : '待检测'">
                  </div>
                  <span class="model-name" @click.stop="goToChatWithModel(endpoint.id, getModelName(model))">
                    {{ getModelName(model) }}
                  </span>
                  <button class="model-copy-btn" @click.stop="copyToClipboard(getModelName(model))" title="复制模型名称">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              <div v-else class="empty-models" style="
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 8px;
              ">
                <i class="fas fa-cube" style="font-size: 20px; opacity: 0.3"></i>
                <span>暂无模型数据，可在账号管理中刷新获取</span>
              </div>
            </div>
          </div>
        </div>

        <div v-if="openaiEndpoints.length === 0" class="empty-state" style="padding: 40px">
          <i class="fas fa-robot" style="font-size: 48px; margin-bottom: 16px"></i>
          <div>暂无 API 端点，可在账号管理中添加</div>
        </div>
      </div>
    </template>
  </div>

  <!-- 账号管理标签页 -->
  <div v-if="openaiCurrentTab === 'accounts'" class="sub-tab-content quick-fade-in">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <i class="fas fa-server" style="margin-right: 8px; color: #10a37f"></i>API 端点管理
        </div>
        <div class="openai-management-actions" style="display: flex; gap: 8px">
          <button class="btn btn-primary paas-control-btn" @click="openaiHealthCheckModal = true" title="健康检测">
            <i class="fas fa-heartbeat"></i> <span>健康检测</span>
          </button>
          <button class="btn btn-success paas-control-btn" @click="openAddOpenaiEndpointModal" title="添加账号">
            <i class="fas fa-plus"></i> <span>添加账号</span>
          </button>
          <button class="btn btn-secondary paas-control-btn" @click="refreshAllOpenaiEndpoints"
            :disabled="openaiRefreshing" title="刷新全部">
            <i class="fas fa-sync-alt" :class="{ 'fa-spin': openaiRefreshing }"></i>
            <span>刷新全部</span>
          </button>
          <button class="btn btn-secondary paas-control-btn" @click="exportOpenaiEndpoints" title="导出">
            <i class="fas fa-upload"></i> <span>导出</span>
          </button>
          <button class="btn btn-secondary paas-control-btn" @click="importOpenaiEndpointsFromFile" title="导入">
            <i class="fas fa-download"></i> <span>导入</span>
          </button>
        </div>
      </div>

      <div v-if="openaiLoading" class="loading">
        <div class="spinner"></div>
        <div style="margin-top: 12px">加载中...</div>
      </div>

      <div v-else class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>API 地址</th>
              <th>API Key</th>
              <th class="text-center">状态</th>
              <th class="text-center">模型数量</th>
              <th class="text-center">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="endpoint in openaiEndpoints" :key="endpoint.id">
              <td><strong>{{ endpoint.name || '未命名' }}</strong></td>
              <td><code>{{ maskAddress(endpoint.baseUrl, serverIpDisplayMode) }}</code></td>
              <td>
                <code>{{ endpoint.showKey ? endpoint.apiKey : maskApiKey(endpoint.apiKey) }}</code>
                <button class="copy-btn" @click.stop="endpoint.showKey = !endpoint.showKey" style="margin-left: 4px">
                  <i class="fas" :class="endpoint.showKey ? 'fa-eye-slash' : 'fa-eye'"></i>
                </button>
              </td>
              <td class="text-center">
                <span class="ag-status-badge"
                  :class="endpoint.status === 'valid' ? 'ag-status-online' : (endpoint.status === 'invalid' ? 'ag-status-error' : 'ag-status-unknown')">
                  {{ endpoint.status === 'valid' ? '有效' : (endpoint.status === 'invalid' ? '无效'
                  : '未验证') }}
                </span>
              </td>
              <td class="text-center">{{ endpoint.models ? endpoint.models.length : 0 }}</td>
              <td class="actions text-center">
                <div class="flex-cell">
                  <button class="btn btn-icon-refined" @click="verifyOpenaiEndpoint(endpoint)" title="验证连接">
                    <i class="fas fa-plug"></i>
                  </button>
                  <button class="btn btn-icon-refined" @click="openHealthCheckForEndpoint(endpoint.id)" title="模型健康检测">
                    <i class="fas fa-heartbeat"></i>
                  </button>
                  <button class="btn btn-icon-refined" @click="editOpenaiEndpoint(endpoint)" title="编辑配置">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-icon-refined" @click="deleteOpenaiEndpoint(endpoint)" title="删除账号"
                    style="color: var(--danger-color)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <div v-if="openaiEndpoints.length === 0" class="empty-state">
          <div>暂无 API 账号，点击上方按钮添加</div>
        </div>
      </div>
    </div>

    <!-- 批量添加 -->
    <div class="panel" style="margin-top: 16px">
      <div class="panel-header">
        <div class="panel-title">
          <i class="fas fa-layer-group" style="margin-right: 8px; color: #10a37f"></i>批量添加端点
        </div>
      </div>
      <div>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px">
          每行一个端点，格式：<code>名称:API地址:API_Key</code>
        </p>
        <textarea v-model="openaiBatchText" class="form-textarea" placeholder="每行一个: 名称:https://api.example.com:sk-xxx"
          style="min-height: 120px; font-family: var(--font-mono); font-size: 12px"></textarea>
        <div v-if="openaiBatchError" class="form-error" style="margin-top: 8px">
          {{ openaiBatchError }}
        </div>
        <div v-if="openaiBatchSuccess" class="form-success" style="margin-top: 8px">
          {{ openaiBatchSuccess }}
        </div>
        <button class="btn btn-primary" @click="batchAddOpenaiEndpoints" :disabled="openaiAdding"
          style="width: 100%; margin-top: 12px">
          {{ openaiAdding ? '添加中...' : '批量添加' }}
        </button>
      </div>
    </div>
  </div>

  <!-- 对话标签页 -->
  <div v-if="openaiCurrentTab === 'chat'" class="sub-tab-content quick-fade-in theme-openai-chat"
    @vue:mounted="loadChatSessions">
    <div class="chat-layout">
      <!-- 移动端侧边栏遮罩层 -->
      <div class="mobile-sidebar-overlay" :class="{ 'active': openaiChatMobileSidebarOpen }"
        @click="openaiChatMobileSidebarOpen = false"></div>
      <!-- 历史记录侧边栏 -->
      <div class="chat-history-sidebar modern-glass-sidebar" :class="{ 'active-mobile': openaiChatMobileSidebarOpen }">
        <div class="sidebar-content-wrapper">
          <div class="chat-history-header">
            <div class="history-header-left">
              <span class="history-title" v-if="openaiChatSelectedSessionIds.length > 0">已选 {{
                openaiChatSelectedSessionIds.length }}</span>
              <div class="history-header-actions">
                <!-- 全选按钮 -->
                <button v-if="openaiChatSessions.length > 0" class="btn btn-icon-refined btn-select-all"
                  @click="toggleSelectAllSessions"
                  :title="openaiChatSelectedSessionIds.length === openaiChatSessions.length ? '取消全选' : '全选'">
                  <i class="fas"
                    :class="openaiChatSelectedSessionIds.length === openaiChatSessions.length ? 'fa-check-square' : 'fa-square'"></i>
                </button>
                <!-- 批量删除按钮 -->
                <button v-if="openaiChatSelectedSessionIds.length > 0"
                  class="btn btn-icon-refined btn-batch-delete text-danger" @click="deleteSelectedOpenaiChatSessions"
                  title="删除选中项目">
                  <i class="fas fa-trash-alt"></i>
                </button>
                <!-- 清空按钮 (仅在未选中任何项目时显示) -->
                <button v-if="openaiChatSessions.length > 0 && openaiChatSelectedSessionIds.length === 0"
                  class="btn btn-icon-refined btn-clear-history" @click="clearAllOpenaiChatSessions" title="清空历史记录">
                  <i class="fas fa-circle-xmark"></i>
                </button>
              </div>
            </div>
          </div>
          <button class="new-chat-btn" @click="createChatSession(true)">
            <i class="fas fa-plus"></i>
            <span>新对话</span>
          </button>
          <div class="chat-history-list">
            <div v-if="openaiChatHistoryLoading" class="history-loading">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div v-else v-for="session in openaiChatSessions" :key="session.id" class="chat-history-item"
              :class="{ active: session.id === openaiChatCurrentSessionId, selected: openaiChatSelectedSessionIds.includes(session.id) }"
              @click="loadChatSession(session.id)">
              <i class="fas fa-comment-alt"></i>
              <span class="session-title">{{ getSafeSessionTitle(session.title) }}</span>
              <div class="session-selector" @click.stop="toggleSessionSelection(session.id)">
                <i class="far"
                  :class="openaiChatSelectedSessionIds.includes(session.id) ? 'fa-check-square' : 'fa-square'"></i>
              </div>
              <button class="delete-btn" @click.stop="deleteChatSession(session.id)" title="删除">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 主聊天区域 -->
      <div class="chat-main">
        <div class="openai-chat-container">
          <!-- 顶部设置栏 -->
          <div class="openai-chat-toolbar">
            <div class="chat-model-selector">

              <!-- 人设选择器 (Custom Dropdown) -->
              <div class="custom-select-container persona-select">
                <div class="custom-select-trigger" @click.stop="togglePersonaDropdown($event)">
                  <i class="fas" :class="getCurrentPersonaIcon()" title="选择 AI 人设"></i>
                  <div class="selected-text" :title="getCurrentPersonaName()">
                    {{ getCurrentPersonaName() }}
                  </div>
                  <i class="fas fa-chevron-down arrow" :class="{ 'open': showPersonaDropdown }"></i>
                </div>
                <!-- 人设下拉列表 -->
                <div class="custom-select-options full-width persona-options" v-if="showPersonaDropdown" @click.stop>
                  <div class="custom-option" v-for="persona in openaiPersonas" :key="persona.id"
                    :class="{ 'selected': openaiCurrentPersonaId == persona.id }" @click="selectPersona(persona.id)">
                    <i class="fas" :class="persona.icon" style="width: 14px; margin-right: 8px;"></i>
                    <div class="option-label" style="flex: 1;">{{ persona.name }}</div>
                    <div class="option-actions" style="display: flex; gap: 8px; opacity: 0.5;">
                      <i class="fas fa-edit" @click.stop="openPersonaModal(persona)" title="编辑"
                        style="cursor: pointer;"></i>
                      <i class="fas fa-trash-alt" v-if="!persona.is_default" @click.stop="deletePersona(persona.id)"
                        title="删除" style="cursor: pointer;"></i>
                    </div>
                  </div>
                  <div class="custom-option add-new" @click="openPersonaModal()" style="color: var(--accent-color);">
                    <i class="fas fa-plus" style="margin-right: 8px;"></i>
                    <div class="option-label">新增人设</div>
                  </div>
                </div>
              </div>

              <!-- 端点选择器 (Custom Dropdown) -->
              <div class="custom-select-container endpoint-select">
                <div class="custom-select-trigger" @click.stop="toggleEndpointDropdown($event)">
                  <i class="fas fa-server" title="选择 API 端点"></i>
                  <div class="selected-text" :title="getEndpointName(openaiChatEndpoint) || '所有端点'">
                    {{ getEndpointName(openaiChatEndpoint) || '所有端点' }}
                  </div>
                  <i class="fas fa-chevron-down arrow" :class="{ 'open': openaiShowEndpointDropdown }"></i>
                </div>
                <!-- 端点下拉列表 -->
                <div class="custom-select-options full-width" v-if="openaiShowEndpointDropdown" @click.stop>
                  <div class="custom-option" :class="{ 'selected': !openaiChatEndpoint }" @click="selectEndpoint('')">
                    <div class="option-label">所有端点</div>
                    <i class="fas fa-check" v-if="!openaiChatEndpoint"></i>
                  </div>
                  <div class="custom-option" v-for="ep in openaiEndpoints" :key="ep.id"
                    :class="{ 'selected': openaiChatEndpoint === ep.id }" @click="selectEndpoint(ep.id)">
                    <div class="option-label">{{ ep.name }}</div>
                    <i class="fas fa-check" v-if="openaiChatEndpoint === ep.id"></i>
                  </div>
                </div>
              </div>

              <!-- 模型选择器 (Custom Dropdown with Search) -->
              <div class="custom-select-container model-selector" style="flex: 1; min-width: 0;">
                <div class="custom-select-trigger" @click.stop="toggleModelDropdown($event)">
                  <i class="fas fa-robot" title="选择模型"></i>
                  <div class="selected-text" :title="openaiChatModel">{{ openaiChatModel || '选择模型' }}</div>
                  <i class="fas fa-chevron-down arrow" :class="{ 'open': openaiShowModelDropdown }"></i>
                </div>
                <!-- 模型下拉列表 -->
                <div class="custom-select-options full-width" v-if="openaiShowModelDropdown" @click.stop>
                  <!-- 搜索框 -->
                  <div class="dropdown-search">
                    <i class="fas fa-search"></i>
                    <input ref="modelSearchInput" v-model="dropdownModelSearch" placeholder="搜索模型..." @click.stop
                      autocomplete="off" />
                  </div>

                  <!-- 列表内容 -->
                  <div v-if="filteredChatModels.length > 0">
                    <!-- 收藏的模型 (仅在非搜索状态下分组显示) -->
                    <template v-if="openaiPinnedModels.length > 0 && !dropdownModelSearch">
                      <div class="option-group-label" style="display: flex; align-items: center; gap: 4px;">
                        <i class="fas fa-star" style="font-size: 10px; color: #eab308;"></i> 收藏
                      </div>
                      <div class="custom-option"
                        v-for="modelId in openaiPinnedModels.filter(id => filteredChatModels.some(m => m.id === id))"
                        :key="'pinned-' + modelId" :class="{ 'selected': openaiChatModel === modelId }"
                        @click="selectChatModelForDropdown(modelId)">
                        <div class="option-label">{{ modelId }}</div>
                        <i class="fas fa-check" v-if="openaiChatModel === modelId"></i>
                      </div>
                      <div class="option-group-label" style="margin-top: 4px;">所有模型</div>
                    </template>

                    <!-- 模型列表 -->
                    <div class="custom-option" v-for="model in dropdownFilteredChatModels" :key="model.id"
                      v-show="!(!dropdownModelSearch && openaiPinnedModels.includes(model.id))"
                      :class="{ 'selected': openaiChatModel === model.id }"
                      @click="selectChatModelForDropdown(model.id)">
                      <div class="option-label">{{ model.id }}</div>
                      <i class="fas fa-check" v-if="openaiChatModel === model.id"></i>
                    </div>
                  </div>
                  <div v-else class="custom-option"
                    style="justify-content:center; opacity:0.5; cursor: default; padding: 20px 0;">
                    无匹配模型
                  </div>
                </div>
              </div>

              <!-- 操作按钮 -->
              <button class="btn btn-icon-refined" @click="updateOpenaiAllModels(true)" title="刷新模型列表"
                :disabled="openaiLoading">
                <i class="fas fa-sync-alt" :class="{ 'fa-spin': openaiLoading }"></i>
              </button>
              <button class="btn btn-icon-refined" @click="togglePinModel(openaiChatModel)"
                :title="openaiPinnedModels.includes(openaiChatModel) ? '取消收藏' : '收藏当前模型'"
                :class="{ 'is-pinned': openaiPinnedModels.includes(openaiChatModel) }" :disabled="!openaiChatModel">
                <i class="fas fa-star"></i>
              </button>
              <button class="btn btn-icon-refined" @click="setDefaultChatModel"
                :title="openaiChatModel === openaiDefaultChatModel ? '当前为默认模型' : '设为默认模型（启动时自动选中）'"
                :class="{ 'is-default': openaiChatModel === openaiDefaultChatModel }" :disabled="!openaiChatModel">
                <i class="fas fa-thumbtack"></i>
              </button>
            </div>

            <!-- 收藏模型快捷按钮 -->
            <!-- <div v-if="openaiPinnedModels.length > 0" class="pinned-models-bar">
              <button v-for="modelId in openaiPinnedModels" :key="'quick-' + modelId" class="pinned-model-chip"
                :class="{ 'active': openaiChatModel === modelId }" @click="openaiChatModel = modelId" :title="modelId">
                {{ modelId.length > 20 ? modelId.slice(0, 18) + '...' : modelId }}
              </button>
            </div> -->
            <div class="chat-actions">
              <!-- 移动端历史记录按钮 -->
              <button class="btn btn-secondary btn-sm mobile-history-toggle"
                @click="openaiChatMobileSidebarOpen = !openaiChatMobileSidebarOpen">
                <i class="fas fa-history"></i> 历史
              </button>
              <button class="btn btn-secondary btn-sm" @click="clearOpenaiChat">
                <i class="fas fa-trash-alt"></i> 清除
              </button>
              <button class="btn btn-secondary btn-sm" @click="showHChatSettingsModal = true">
                <i class="fas fa-cog"></i> 设置
              </button>
            </div>
          </div>

          <!-- 消息列表 -->
          <div class="openai-chat-messages" id="openai-chat-messages"
            :class="{ 'history-loading': openaiChatHistoryLoading }" @scroll="handleChatScroll($event)">

            <!-- 加载中遮罩 -->
            <div v-if="openaiChatHistoryLoading" class="chat-loading-overlay">
              <div class="loading-spinner"></div>
              <span>加载对话中...</span>
            </div>
            <div v-if="openaiChatMessages.length === 0" class="chat-empty-state">
              <div class="empty-icon"><i class="fas fa-comment-dots"></i></div>
              <h3>OpenAI 兼容对话</h3>
              <p>选择一个模型并开始对话。本模块直接调用配置的 API 端点。</p>
            </div>

            <div v-for="(msg, index) in openaiChatMessages" :key="index" class="chat-message"
              :class="[msg.role, { 'new-message': msg.isNew }]">
              <div class="message-avatar">
                <i :class="msg.role === 'user' ? 'fas fa-user' : 'fas fa-robot'"></i>
              </div>
              <div class="message-content">
                <div class="message-header">
                  <div class="message-role-label">{{ msg.role === 'user' ? 'MOI' : '哈基喵' }}</div>
                  <!-- 时间和模型信息 -->
                  <div class="message-meta">
                    <span v-if="msg.timestamp" class="message-time">{{ formatMessageTime(msg.timestamp) }}</span>
                    <span v-else class="message-time">{{ formatMessageTime(new Date()) }}</span>
                    <span v-if="msg.role === 'assistant' && msg.model" class="message-model" :title="msg.model">{{
                      msg.model }}</span>
                    <span v-else-if="msg.role === 'assistant'" class="message-model" :title="openaiChatModel">{{
                      openaiChatModel }}</span>
                  </div>
                  <div class="message-actions">
                    <!-- 重新生成按钮（不在加载时显示） -->
                    <button v-if="!openaiChatLoading" class="btn-message-action btn-regenerate"
                      @click="regenerateOpenaiChat(index)" :title="msg.role === 'user' ? '从这条消息重新生成' : '重新生成此回答'"
                      tabindex="-1">
                      <i class="fas fa-redo"></i>
                    </button>
                    <!-- 删除按钮 -->
                    <button class="btn-message-action btn-delete" @click="deleteOpenaiChatMessage(index)" title="删除此消息"
                      tabindex="-1">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </div>
                <!-- 思考过程 (如果存在) -->
                <div v-if="msg.reasoning" class="message-reasoning">
                  <div class="reasoning-header" @click="msg.showReasoning = !msg.showReasoning">
                    <i class="fas fa-brain"></i> 思考过程
                    <!-- <i class="fas" :class="msg.showReasoning ? 'fa-chevron-down' : 'fa-chevron-right'"></i> -->
                  </div>
                  <div v-show="msg.showReasoning" class="reasoning-content"
                    v-html="getCachedMessageHtml(msg, 'reasoning')">
                  </div>
                </div>
                <!-- 正文 -->
                <div class="message-text" v-html="getCachedMessageHtml(msg, 'content')"></div>
              </div>
            </div>

            <!-- 正在加载 -->
            <div v-if="openaiChatLoading" class="chat-message assistant loading">
              <div class="message-avatar"><i class="fas fa-robot"></i></div>
              <div class="message-content">
                <div class="message-header">
                  <div class="message-role-label">哈基喵</div>
                  <button class="btn-message-action btn-stop" @click="stopOpenaiChat" title="停止生成" tabindex="-1">
                    <i class="fas fa-stop"></i>
                  </button>
                </div>
                <div class="typing-indicator"><span></span><span></span><span></span></div>
              </div>
            </div>
          </div>

          <!-- 输入框 -->
          <div class="openai-chat-input-wrapper">
            <!-- 附件预览 -->
            <div v-if="openaiChatAttachments.length > 0" class="chat-attachments-preview">
              <div v-for="(file, index) in openaiChatAttachments" :key="index" class="attachment-item">
                <img :src="file.url" alt="预览" />
                <button class="btn-remove-attachment" @click="removeOpenaiChatAttachment(index)" tabindex="-1">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <div class="input-panel">
              <input type="file" ref="chatFileInput" style="display: none" accept="image/*" multiple
                @change="handleOpenaiChatFileSelect" />
              <button class="btn-attachment" @click="$refs.chatFileInput.click()" title="上传图片" tabindex="-1">
                <i class="fas fa-image"></i>
              </button>
              <div class="input-divider"></div>
              <textarea v-model="openaiChatMessageInput" class="chat-textarea" placeholder="输入消息，Shift+Enter换行..."
                rows="1" @keydown.enter.exact.prevent="sendOpenaiChatMessage" @input="autoResizeTextarea($event, true)"
                @paste="handleOpenaiChatPaste"></textarea>
              <button class="btn-send-chat"
                :disabled="(!openaiChatMessageInput.trim() && openaiChatAttachments.length === 0) || openaiChatLoading"
                @click="sendOpenaiChatMessage" tabindex="-1">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>

          <!-- 滚动到底部按钮 (用户向上滚动时显示) -->
          <transition name="fade">
            <button v-if="!openaiChatAutoScroll && openaiChatMessages.length > 0" class="scroll-to-bottom-btn"
              @click="openaiScrollToBottom(true, true)" title="滚动到底部">
              <i class="fas fa-chevron-down"></i>
            </button>
          </transition>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- 模型健康检测配置弹窗 -->
<div v-if="openaiHealthCheckModal" class="modal-overlay" @click.self="openaiHealthCheckModal = false">
  <div class="modal health-check-modal theme-openai">
    <div class="modal-header">
      <div class="modal-title">模型健康检测</div>
      <button class="modal-close" @click="openaiHealthCheckModal = false">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <!-- 警告提示 -->
      <div class="health-check-warning">
        <div class="warning-icon">
          <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="warning-text">
          <div class="warning-title">警告</div>
          <p>健康检测需要发送请求，请谨慎使用。按次收费的模型可能产生更多费用，请自行承担。</p>
        </div>
      </div>

      <!-- 配置选项 -->
      <div class="health-config-options">
        <div class="config-item">
          <div class="config-label">使用密钥:</div>
          <div class="config-control">
            <div class="toggle-group">
              <button class="btn btn-xs" :class="{ 'active': openaiHealthCheckForm.useKey === 'single' }"
                @click="openaiHealthCheckForm.useKey = 'single'">单个</button>
              <button class="btn btn-xs" :class="{ 'active': openaiHealthCheckForm.useKey === 'all' }"
                @click="openaiHealthCheckForm.useKey = 'all'">所有</button>
            </div>
          </div>
        </div>

        <div class="config-item">
          <div class="config-label">并发检测:</div>
          <div class="config-control">
            <div class="toggle-group">
              <button class="btn btn-xs" :class="{ 'active': !openaiHealthCheckForm.concurrency }"
                @click="openaiHealthCheckForm.concurrency = false">关闭</button>
              <button class="btn btn-xs" :class="{ 'active': openaiHealthCheckForm.concurrency }"
                @click="openaiHealthCheckForm.concurrency = true">开启</button>
            </div>
          </div>
        </div>

        <div class="config-item">
          <div class="config-label">超时:</div>
          <div class="config-control">
            <div class="input-with-unit">
              <input type="number" v-model.number="openaiHealthCheckForm.timeout" class="form-input" min="1" max="60">
              <span class="unit">s</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" @click="openaiHealthCheckModal = false">取消</button>
      <button class="btn btn-success" @click="startOpenaiHealthCheck" :disabled="openaiModelHealthBatchLoading">
        <i class="fas" :class="openaiModelHealthBatchLoading ? 'fa-spinner fa-spin' : 'fa-play'"></i>
        {{ openaiModelHealthBatchLoading ? '检测中...' : '开始' }}
      </button>
    </div>
  </div>
</div>
<!-- 人设编辑弹窗 -->
<div v-if="showPersonaModal" class="modal-overlay persona-modal-overlay" @click.self="showPersonaModal = false">
  <div class="modal persona-modal theme-openai" style="max-width: 500px;">
    <div class="modal-header">
      <div class="modal-title">{{ editingPersona ? '编辑人设' : '新增人设' }}</div>
      <button class="modal-close" @click="showPersonaModal = false">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom: 5px;">
        <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">人设名称</label>
        <input type="text" v-model="personaForm.name" class="form-input" placeholder="例如：翻译专家、Java架构师"
          style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
      </div>
      <div class="form-group" style="margin-bottom: 5px;">
        <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">图标 (FontAwesome
          Class)</label>
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <div class="current-icon-preview">
            <i class="fas" :class="personaForm.icon || 'fa-robot'"></i>
          </div>
          <input type="text" v-model="personaForm.icon" class="form-input"
            placeholder="例如：fa-robot, fa-cat, fa-user-ninja"
            style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
        </div>
        <!-- 常用图标选择器 -->
        <div class="preset-icons-grid">
          <div v-for="iconClass in getPresetIcons()" :key="iconClass" class="preset-icon-item"
            :class="{ active: personaForm.icon === iconClass }" @click="personaForm.icon = iconClass"
            :title="iconClass">
            <i class="fas" :class="iconClass"></i>
          </div>
        </div>
      </div>
      <div class="form-group" style="margin-bottom: 5px;">
        <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">系统提示词 (System
          Prompt)</label>
        <textarea v-model="personaForm.systemPrompt" class="form-input" rows="6" placeholder="定义 AI 的身份和行为准则..."
          style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); resize: vertical;"></textarea>
      </div>
    </div>
    <div class="modal-footer"
      style="padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px;">
      <button class="btn btn-secondary" @click="showPersonaModal = false" style="padding: 8px 16px;">取消</button>
      <button class="btn btn-primary" @click="savePersona"
        style="padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 6px;">
        <i class="fas fa-save" style="margin-right: 5px;"></i> 保存人设
      </button>
    </div>
  </div>
</div>
<!-- ==================== OpenAI API 管理部分结束 ==================== -->