<!-- AI Draw 模块模板 -->
<div class="tab-content ai-draw-tab-content theme-ai-draw" :class="getTabAnimationClass('ai-draw')">
  <div class="sec-tabs">
    <button type="button" class="tab-btn" :class="{ active: aiDrawCurrentTab === 'projects' }"
      @click="aiDrawCurrentTab = 'projects'">
      <i class="fas fa-folder-open"></i> 项目
    </button>
    <button type="button" class="tab-btn" :class="{ active: aiDrawCurrentTab === 'editor' }"
      @click="aiDrawCurrentTab = 'editor'" :disabled="!aiDrawCurrentProject">
      <i class="fas fa-edit"></i> 编辑器
    </button>
    <button type="button" class="tab-btn" :class="{ active: aiDrawCurrentTab === 'settings' }"
      @click="aiDrawCurrentTab = 'settings'">
      <i class="fas fa-cog"></i> 设置
    </button>
  </div>

  <div v-show="aiDrawCurrentTab === 'projects'" class="sub-tab-content quick-fade-in">
    <div class="panel">
      <div class="panel-header ai-draw-panel-header">
        <div class="panel-title ai-draw-title">
          <i class="fas fa-palette"></i>绘图项目
          <span class="ai-draw-counter">({{ aiDrawProjects.length }})</span>
        </div>
        <div class="ai-draw-actions-bar">
          <div class="totp-search-box ai-draw-search-box">
            <i class="fas fa-search"></i>
            <input v-model="aiDrawSearchQuery" type="text" placeholder="搜索项目..." />
          </div>
          <div class="dropdown ai-draw-create-dropdown" ref="aiDrawCreateDropdown">
            <button type="button" class="btn btn-primary" @click="aiDrawShowCreateMenu = !aiDrawShowCreateMenu">
              <i class="fas fa-plus"></i> 新建项目
              <i class="fas fa-chevron-down ai-draw-chevron"></i>
            </button>
            <div v-if="aiDrawShowCreateMenu" class="dropdown-menu ai-draw-menu">
              <button type="button" class="dropdown-item ai-draw-menu-item" @click="aiDrawCreateProject('mermaid')">
                <i class="fas fa-sitemap ai-draw-icon-mermaid"></i>
                Mermaid 图表
              </button>
              <button type="button" class="dropdown-item ai-draw-menu-item" @click="aiDrawCreateProject('drawio')">
                <i class="fas fa-project-diagram ai-draw-icon-drawio"></i>
                Draw.io 图表
              </button>
            </div>
          </div>
        </div>
      </div>

      <div v-if="aiDrawLoading" class="loading ai-draw-state">
        <div class="spinner"></div>
        <div class="ai-draw-loading-text">加载中...</div>
      </div>

      <div v-else-if="filteredAiDrawProjects.length === 0" class="empty-state ai-draw-state">
        <i class="fas fa-palette ai-draw-empty-icon"></i>
        <div>{{ aiDrawSearchQuery ? '没有匹配的项目' : '暂无绘图项目' }}</div>
        <button v-if="!aiDrawSearchQuery" type="button" class="btn btn-primary ai-draw-empty-btn"
          @click="aiDrawCreateProject('mermaid')">
          <i class="fas fa-plus"></i> 创建第一个项目
        </button>
      </div>

      <div v-else class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th class="ai-draw-col-name">项目名称</th>
              <th class="text-center ai-draw-col-type">类型</th>
              <th class="text-center ai-draw-col-updated">更新时间</th>
              <th class="text-center ai-draw-col-actions">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="project in filteredAiDrawProjects" :key="project.id">
              <td>
                <div class="ai-draw-project-cell">
                  <i :class="[
                    project.engine_type === 'mermaid' ? 'fas fa-sitemap' : 'fas fa-project-diagram',
                    project.engine_type === 'mermaid' ? 'ai-draw-icon-mermaid' : 'ai-draw-icon-drawio'
                  ]"></i>
                  <button type="button" class="ai-draw-project-title" @click="aiDrawOpenProject(project)">
                    {{ project.title || '未命名' }}
                  </button>
                </div>
              </td>
              <td class="text-center">
                <span class="record-type" :class="project.engine_type">
                  {{ project.engine_type === 'mermaid' ? 'Mermaid' : 'Draw.io' }}
                </span>
              </td>
              <td class="text-center">
                <div class="log-time">{{ aiDrawFormatDate(project.updated_at) }}</div>
              </td>
              <td class="actions text-center">
                <div class="flex-cell">
                  <button type="button" class="btn btn-icon-refined" @click="aiDrawOpenProject(project)" title="编辑">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="btn btn-icon-refined ai-draw-danger-btn"
                    @click="aiDrawDeleteProject(project.id)" title="删除">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div v-show="aiDrawCurrentTab === 'editor' && aiDrawCurrentProject" class="sub-tab-content quick-fade-in">
    <div class="panel-header ai-draw-editor-toolbar">
      <div class="panel-title ai-draw-editor-title">
        <button type="button" class="btn btn-secondary btn-sm ai-draw-back-btn"
          @click="aiDrawCurrentTab = 'projects'; aiDrawCurrentProject = null">
          <i class="fas fa-arrow-left"></i>
        </button>
        <i :class="[
          aiDrawCurrentProject?.engine_type === 'mermaid' ? 'fas fa-sitemap' : 'fas fa-project-diagram',
          aiDrawCurrentProject?.engine_type === 'mermaid' ? 'ai-draw-icon-mermaid' : 'ai-draw-icon-drawio'
        ]"></i>
        <input type="text" class="form-input ai-draw-title-input" :value="aiDrawCurrentProject?.title"
          @blur="aiDrawUpdateTitle($event.target.value)" @keyup.enter="$event.target.blur()" />
      </div>
      <div class="ai-draw-editor-actions">
        <button type="button" class="btn btn-secondary" @click="aiDrawShowChat = !aiDrawShowChat"
          :class="{ active: aiDrawShowChat }">
          <i class="fas fa-robot"></i> AI 助手
        </button>
        <button type="button" class="btn btn-primary" @click="aiDrawSaveProject" :disabled="aiDrawSaving">
          <i :class="aiDrawSaving ? 'fas fa-spinner fa-spin' : 'fas fa-save'"></i> 保存
        </button>
        <button type="button" class="btn btn-secondary" @click="aiDrawExport">
          <i class="fas fa-download"></i> 导出
        </button>
      </div>
    </div>

    <div v-if="aiDrawCurrentProject?.engine_type === 'mermaid'" class="ai-draw-editor-container">
      <div class="ai-draw-editor-main" :class="{ 'chat-visible': aiDrawShowChat }">
        <div class="mermaid-split-view">
          <div class="mermaid-code-panel">
            <div class="mermaid-panel-header">
              <span><i class="fas fa-code"></i> Mermaid 代码</span>
              <button type="button" class="btn btn-ghost btn-xs" @click="aiDrawFormatMermaid">
                <i class="fas fa-magic"></i> 格式化
              </button>
            </div>
            <textarea class="mermaid-textarea" v-model="aiDrawMermaidCode" @input="aiDrawRenderMermaid"
              placeholder="输入 Mermaid 代码..." spellcheck="false"></textarea>
          </div>
          <div class="mermaid-preview-panel">
            <div class="mermaid-panel-header">
              <span><i class="fas fa-eye"></i> 预览</span>
            </div>
            <div class="mermaid-preview-content" ref="mermaidPreview">
              <div v-if="aiDrawMermaidError" class="mermaid-error">
                <i class="fas fa-exclamation-triangle"></i>
                <pre>{{ aiDrawMermaidError }}</pre>
              </div>
              <div v-else class="mermaid-svg" v-html="aiDrawMermaidSvg"></div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="aiDrawShowChat" class="ai-draw-chat-sidebar">
        <div class="ai-draw-chat-header">
          <span><i class="fas fa-robot"></i> AI 助手</span>
          <button type="button" class="btn btn-ghost btn-xs" @click="aiDrawShowChat = false">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="ai-draw-chat-messages" ref="aiDrawChatContainer">
          <div v-if="aiDrawChatMessages.length === 0" class="ai-draw-chat-empty">
            <i class="fas fa-comments"></i>
            <p>描述你想要的图表，AI 将帮你生成</p>
            <div class="ai-draw-chat-suggestions">
              <button type="button" @click="aiDrawSendMessage('帮我画一个用户登录的流程图')">画一个登录流程图</button>
              <button type="button" @click="aiDrawSendMessage('生成一个简单的类图')">画一个类图</button>
            </div>
          </div>
          <div v-for="(msg, idx) in aiDrawChatMessages" :key="idx" :class="['ai-draw-chat-message', msg.role]">
            <div class="ai-draw-message-content">
              <template v-if="msg.role === 'assistant'">
                <div v-html="aiDrawRenderMarkdown(msg.content)"></div>
                <button type="button" class="btn btn-xs btn-primary ai-draw-apply-btn"
                  @click="aiDrawApplyCode(msg.content)">
                  <i class="fas fa-check"></i> 应用到编辑器
                </button>
              </template>
              <template v-else>{{ msg.content }}</template>
            </div>
          </div>
          <div v-if="aiDrawChatLoading" class="ai-draw-chat-message assistant">
            <div class="ai-draw-message-content">
              <i class="fas fa-spinner fa-spin"></i> 思考中...
            </div>
          </div>
        </div>
        <div class="ai-draw-chat-input">
          <textarea v-model="aiDrawChatInput" placeholder="描述你想要的图表..." @keydown.enter.exact.prevent="aiDrawSendMessage()"
            rows="2"></textarea>
          <button type="button" class="btn btn-primary" @click="aiDrawSendMessage()"
            :disabled="!aiDrawChatInput.trim() || aiDrawChatLoading">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <div v-else-if="aiDrawCurrentProject?.engine_type === 'drawio'" class="ai-draw-editor-container">
      <iframe ref="drawioFrame" :src="aiDrawDrawioUrl" frameborder="0" class="drawio-iframe"
        @load="aiDrawOnDrawioLoad"></iframe>
    </div>
  </div>

  <div v-show="aiDrawCurrentTab === 'settings'" class="sub-tab-content quick-fade-in">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title ai-draw-title">
          <i class="fas fa-plug"></i>AI Provider 配置
          <span class="ai-draw-counter">({{ aiDrawProviders.length }})</span>
        </div>
        <button type="button" class="btn btn-primary" @click="aiDrawOpenProviderModal">
          <i class="fas fa-plus"></i> 添加 Provider
        </button>
      </div>

      <div v-if="aiDrawProviders.length === 0" class="empty-state ai-draw-settings-empty">
        <i class="fas fa-plug ai-draw-settings-empty-icon"></i>
        <div>暂未配置 AI Provider</div>
        <div class="ai-draw-help-text">添加一个 Provider 以启用 AI 辅助功能</div>
      </div>

      <div v-else class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th class="ai-draw-provider-name-col">名称</th>
              <th class="text-center ai-draw-provider-source-col">来源</th>
              <th class="ai-draw-provider-model-col">模型</th>
              <th class="text-center ai-draw-provider-status-col">状态</th>
              <th class="text-center ai-draw-provider-actions-col">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="provider in aiDrawProviders" :key="provider.id">
              <td>
                <div class="ai-draw-provider-name-wrap">
                  <i class="fas fa-star ai-draw-provider-default" v-if="provider.is_default" title="默认 Provider"></i>
                  <strong>{{ provider.name }}</strong>
                </div>
              </td>
              <td class="text-center">
                <span class="record-type" :class="provider.source_type">
                  {{ provider.source_type === 'internal' ? '内部' : '外部' }}
                </span>
              </td>
              <td>
                <code class="ai-draw-provider-code">{{ provider.default_model || '-' }}</code>
              </td>
              <td class="text-center">
                <span :class="['status-badge', provider.enabled ? 'online' : 'offline']">
                  {{ provider.enabled ? '启用' : '禁用' }}
                </span>
              </td>
              <td class="actions text-center">
                <div class="flex-cell">
                  <button type="button" class="btn btn-icon-refined" @click="aiDrawTestProvider(provider)" title="测试连接"
                    :disabled="aiDrawTestingProvider === provider.id">
                    <i :class="aiDrawTestingProvider === provider.id ? 'fas fa-spinner fa-spin' : 'fas fa-bolt'"></i>
                  </button>
                  <button type="button" class="btn btn-icon-refined" @click="aiDrawEditProvider(provider)" title="编辑">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="btn btn-icon-refined" v-if="!provider.is_default"
                    @click="aiDrawSetDefaultProvider(provider.id)" title="设为默认">
                    <i class="fas fa-star"></i>
                  </button>
                  <button type="button" class="btn btn-icon-refined ai-draw-danger-btn"
                    @click="aiDrawDeleteProvider(provider.id)" title="删除">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="panel ai-draw-stats-panel">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-chart-bar"></i>统计信息</div>
      </div>
      <div class="totp-settings-content">
        <div class="settings-stats">
          <div class="stat-item">
            <span class="stat-value">{{ aiDrawProjects.length }}</span>
            <span class="stat-label">个项目</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ aiDrawProjects.filter(p => p.engine_type === 'mermaid').length }}</span>
            <span class="stat-label">Mermaid</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ aiDrawProjects.filter(p => p.engine_type === 'drawio').length }}</span>
            <span class="stat-label">Draw.io</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ aiDrawProviders.filter(p => p.enabled).length }}</span>
            <span class="stat-label">已启用 Provider</span>
          </div>
        </div>

        <div class="settings-divider"></div>

        <div class="ai-draw-refresh-actions">
          <button type="button" class="btn btn-secondary" @click="aiDrawLoadProjects">
            <i class="fas fa-sync-alt"></i> 刷新项目列表
          </button>
          <button type="button" class="btn btn-secondary" @click="aiDrawLoadProviders">
            <i class="fas fa-sync-alt"></i> 刷新 Provider
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<Teleport to="body">
  <div v-if="aiDrawShowProviderModal" class="modal-overlay" @click.self="aiDrawShowProviderModal = false">
    <div class="modal ai-draw-provider-modal">
      <div class="modal-header">
        <div class="modal-title ai-draw-title">
          <i class="fas fa-plug"></i>
          {{ aiDrawEditingProvider ? '编辑 Provider' : '添加 Provider' }}
        </div>
        <button type="button" class="modal-close" @click="aiDrawShowProviderModal = false">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body ai-draw-provider-body">
        <div class="form-group">
          <label class="form-label">名称 <span class="ai-draw-required">*</span></label>
          <input type="text" class="form-input" v-model="aiDrawProviderForm.name" placeholder="例如: OpenAI、Claude" />
        </div>

        <div class="form-group">
          <label class="form-label">来源类型</label>
          <div class="ai-draw-source-toggle">
            <button type="button" class="source-btn" :class="{ active: aiDrawProviderForm.source_type === 'external' }"
              @click="aiDrawProviderForm.source_type = 'external'">
              <i class="fas fa-globe"></i>
              <span>外部 API</span>
            </button>
            <button type="button" class="source-btn" :class="{ active: aiDrawProviderForm.source_type === 'internal' }"
              @click="aiDrawProviderForm.source_type = 'internal'; aiDrawLoadInternalProviders()">
              <i class="fas fa-link"></i>
              <span>内部引用</span>
            </button>
          </div>
        </div>

        <template v-if="aiDrawProviderForm.source_type === 'external'">
          <div class="form-group">
            <label class="form-label">API 地址 <span class="ai-draw-required">*</span></label>
            <input type="text" class="form-input" v-model="aiDrawProviderForm.base_url" placeholder="https://api.openai.com/v1" />
          </div>
          <div class="form-group">
            <label class="form-label">API 密钥 <span class="ai-draw-required">*</span></label>
            <input type="password" class="form-input" v-model="aiDrawProviderForm.api_key" placeholder="sk-..." />
          </div>
        </template>

        <template v-if="aiDrawProviderForm.source_type === 'internal'">
          <div class="form-group">
            <label class="form-label">选择内部 Provider <span class="ai-draw-required">*</span></label>
            <select class="form-input" v-model="aiDrawProviderForm.internal_provider_id">
              <option value="">-- 请选择 --</option>
              <option v-for="p in aiDrawInternalProviders" :key="p.id" :value="p.id">
                {{ p.name }} ({{ p.default_model || '无默认模型' }})
              </option>
            </select>
            <div v-if="aiDrawInternalProviders.length === 0" class="form-help ai-draw-warning">
              <i class="fas fa-exclamation-triangle"></i> 未找到可用的内部 Provider，请先在 AI Chat 模块中配置
            </div>
          </div>
        </template>

        <div class="form-group">
          <label class="form-label">默认模型</label>
          <input type="text" class="form-input" v-model="aiDrawProviderForm.default_model"
            placeholder="gpt-4o、claude-3-opus-20240229 等" />
          <div class="form-help">留空将使用 Provider 默认模型</div>
        </div>

        <div class="form-group ai-draw-switch-row">
          <label class="switch-label">
            <input type="checkbox" v-model="aiDrawProviderForm.enabled" />
            <span class="switch"></span>
            <span class="ai-draw-switch-text">启用</span>
          </label>
          <label class="switch-label">
            <input type="checkbox" v-model="aiDrawProviderForm.is_default" />
            <span class="switch"></span>
            <span class="ai-draw-switch-text">设为默认</span>
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @click="aiDrawShowProviderModal = false">取消</button>
        <button type="button" class="btn btn-primary" @click="aiDrawSaveProvider" :disabled="aiDrawSavingProvider">
          <i :class="aiDrawSavingProvider ? 'fas fa-spinner fa-spin' : 'fas fa-check'"></i>
          {{ aiDrawEditingProvider ? '保存修改' : '添加' }}
        </button>
      </div>
    </div>
  </div>
</Teleport>
