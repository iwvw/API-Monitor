<!-- AI Draw 模块模板 - 符合全站设计规范 -->
<div class="tab-content ai-draw-tab-content theme-ai-draw" :class="getTabAnimationClass('ai-draw')">
  <!-- 子标签页 -->
  <div class="sec-tabs">
    <button class="tab-btn" :class="{ active: aiDrawCurrentTab === 'projects' }" @click="aiDrawCurrentTab = 'projects'">
      <i class="fas fa-folder-open"></i> 项目
    </button>
    <button class="tab-btn" :class="{ active: aiDrawCurrentTab === 'editor' }" @click="aiDrawCurrentTab = 'editor'"
      :disabled="!aiDrawCurrentProject">
      <i class="fas fa-edit"></i> 编辑器
    </button>
    <button class="tab-btn" :class="{ active: aiDrawCurrentTab === 'settings' }" @click="aiDrawCurrentTab = 'settings'">
      <i class="fas fa-cog"></i> 设置
    </button>
  </div>

  <!-- ==================== 项目列表 ==================== -->
  <div v-show="aiDrawCurrentTab === 'projects'" class="sub-tab-content quick-fade-in">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <i class="fas fa-palette" style="margin-right: 8px; color: var(--current-primary)"></i>绘图项目
          <span style="font-weight: 400; opacity: 0.6; margin-left: 8px">({{ aiDrawProjects.length }})</span>
        </div>
        <div style="display: flex; gap: 8px; align-items: center">
          <!-- 搜索 -->
          <div class="totp-search-box" style="min-width: 150px">
            <i class="fas fa-search"></i>
            <input v-model="aiDrawSearchQuery" type="text" placeholder="搜索项目..." />
          </div>
          <!-- 新建下拉菜单 -->
          <div class="dropdown" style="position: relative">
            <button class="btn btn-primary" @click="aiDrawShowCreateMenu = !aiDrawShowCreateMenu">
              <i class="fas fa-plus"></i> 新建项目
              <i class="fas fa-chevron-down" style="margin-left: 4px; font-size: 10px"></i>
            </button>
            <div v-if="aiDrawShowCreateMenu" class="dropdown-menu" style="
                position: absolute;
                top: 100%;
                right: 0;
                margin-top: 4px;
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                min-width: 180px;
                z-index: 100;
                overflow: hidden;
              ">
              <button class="dropdown-item" @click="aiDrawCreateProject('mermaid')" style="
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  width: 100%;
                  padding: 10px 14px;
                  border: none;
                  background: none;
                  color: var(--text-primary);
                  cursor: pointer;
                  font-size: 14px;
                ">
                <i class="fas fa-sitemap" style="color: var(--current-primary)"></i>
                Mermaid 图表
              </button>
              <button class="dropdown-item" @click="aiDrawCreateProject('drawio')" style="
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  width: 100%;
                  padding: 10px 14px;
                  border: none;
                  background: none;
                  color: var(--text-primary);
                  cursor: pointer;
                  font-size: 14px;
                ">
                <i class="fas fa-project-diagram" style="color: #f59e0b"></i>
                Draw.io 图表
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 加载状态 -->
      <div v-if="aiDrawLoading" class="loading" style="padding: 60px">
        <div class="spinner"></div>
        <div style="margin-top: 12px">加载中...</div>
      </div>

      <!-- 空状态 -->
      <div v-else-if="filteredAiDrawProjects.length === 0" class="empty-state" style="padding: 60px">
        <i class="fas fa-palette" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3"></i>
        <div>{{ aiDrawSearchQuery ? '没有匹配的项目' : '暂无绘图项目' }}</div>
        <button v-if="!aiDrawSearchQuery" class="btn btn-primary" style="margin-top: 16px"
          @click="aiDrawCreateProject('mermaid')">
          <i class="fas fa-plus"></i> 创建第一个项目
        </button>
      </div>

      <!-- 项目表格 -->
      <div v-else class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 50%">项目名称</th>
              <th class="text-center" style="width: 15%">类型</th>
              <th class="text-center" style="width: 20%">更新时间</th>
              <th class="text-center" style="width: 15%">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="project in filteredAiDrawProjects" :key="project.id">
              <td>
                <div style="display: flex; align-items: center; gap: 10px">
                  <i :class="project.engine_type === 'mermaid' ? 'fas fa-sitemap' : 'fas fa-project-diagram'"
                    :style="{ color: project.engine_type === 'mermaid' ? 'var(--current-primary)' : '#f59e0b' }"></i>
                  <strong style="cursor: pointer" @click="aiDrawOpenProject(project)">{{ project.title || '未命名'
                    }}</strong>
                </div>
              </td>
              <td class="text-center">
                <span class="record-type" :class="project.engine_type">
                  {{ project.engine_type === 'mermaid' ? 'Mermaid' : 'Draw.io' }}
                </span>
              </td>
              <td class="text-center">
                <div class="log-time">{{ aiDrawFormatDate(project.updated_at) }}</div>
              </td>
              <td class="actions text-center">
                <div class="flex-cell">
                  <button class="btn btn-icon-refined" @click="aiDrawOpenProject(project)" title="编辑">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-icon-refined" @click="aiDrawDeleteProject(project.id)" title="删除"
                    style="color: var(--danger-color)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ==================== 编辑器 ==================== -->
  <div v-show="aiDrawCurrentTab === 'editor' && aiDrawCurrentProject" class="sub-tab-content quick-fade-in">
    <!-- 编辑器工具栏 -->
    <div class="panel-header" style="margin-bottom: 16px">
      <div class="panel-title">
        <button class="btn btn-secondary btn-sm" @click="aiDrawCurrentTab = 'projects'; aiDrawCurrentProject = null"
          style="margin-right: 12px">
          <i class="fas fa-arrow-left"></i>
        </button>
        <i :class="aiDrawCurrentProject?.engine_type === 'mermaid' ? 'fas fa-sitemap' : 'fas fa-project-diagram'"
          :style="{ marginRight: '8px', color: aiDrawCurrentProject?.engine_type === 'mermaid' ? 'var(--current-primary)' : '#f59e0b' }"></i>
        <input type="text" class="form-input" style="max-width: 300px; font-weight: 600"
          :value="aiDrawCurrentProject?.title" @blur="aiDrawUpdateTitle($event.target.value)"
          @keyup.enter="$event.target.blur()" />
      </div>
      <div style="display: flex; gap: 8px">
        <button class="btn btn-secondary" @click="aiDrawShowChat = !aiDrawShowChat" :class="{ active: aiDrawShowChat }">
          <i class="fas fa-robot"></i> AI 助手
        </button>
        <button class="btn btn-primary" @click="aiDrawSaveProject" :disabled="aiDrawSaving">
          <i :class="aiDrawSaving ? 'fas fa-spinner fa-spin' : 'fas fa-save'"></i> 保存
        </button>
        <button class="btn btn-secondary" @click="aiDrawExport">
          <i class="fas fa-download"></i> 导出
        </button>
      </div>
    </div>

    <!-- Mermaid 编辑器 -->
    <div v-if="aiDrawCurrentProject?.engine_type === 'mermaid'" class="ai-draw-editor-container">
      <div class="ai-draw-editor-main" :class="{ 'chat-visible': aiDrawShowChat }">
        <div class="mermaid-split-view">
          <!-- 代码面板 -->
          <div class="mermaid-code-panel">
            <div class="mermaid-panel-header">
              <span><i class="fas fa-code"></i> Mermaid 代码</span>
              <button class="btn btn-ghost btn-xs" @click="aiDrawFormatMermaid">
                <i class="fas fa-magic"></i> 格式化
              </button>
            </div>
            <textarea class="mermaid-textarea" v-model="aiDrawMermaidCode" @input="aiDrawRenderMermaid"
              placeholder="输入 Mermaid 代码..." spellcheck="false"></textarea>
          </div>
          <!-- 预览面板 -->
          <div class="mermaid-preview-panel">
            <div class="mermaid-panel-header">
              <span><i class="fas fa-eye"></i> 预览</span>
            </div>
            <div class="mermaid-preview-content" ref="mermaidPreview">
              <div v-if="aiDrawMermaidError" class="mermaid-error">
                <i class="fas fa-exclamation-triangle"></i>
                <pre>{{ aiDrawMermaidError }}</pre>
              </div>
              <div v-else class="mermaid-svg" v-html="aiDrawMermaidSvg"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI 聊天侧栏 -->
      <div v-if="aiDrawShowChat" class="ai-draw-chat-sidebar">
        <div class="ai-draw-chat-header">
          <span><i class="fas fa-robot"></i> AI 助手</span>
          <button class="btn btn-ghost btn-xs" @click="aiDrawShowChat = false">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="ai-draw-chat-messages" ref="aiDrawChatContainer">
          <div v-if="aiDrawChatMessages.length === 0" class="ai-draw-chat-empty">
            <i class="fas fa-comments"></i>
            <p>描述你想要的图表，AI 将帮你生成</p>
            <div class="ai-draw-chat-suggestions">
              <button @click="aiDrawSendMessage('帮我画一个用户登录的流程图')">画一个登录流程图</button>
              <button @click="aiDrawSendMessage('生成一个简单的类图')">画一个类图</button>
            </div>
          </div>
          <div v-for="(msg, idx) in aiDrawChatMessages" :key="idx" :class="['ai-draw-chat-message', msg.role]">
            <div class="ai-draw-message-content">
              <template v-if="msg.role === 'assistant'">
                <div v-html="aiDrawRenderMarkdown(msg.content)"></div>
                <button class="btn btn-xs btn-primary" style="margin-top: 8px" @click="aiDrawApplyCode(msg.content)">
                  <i class="fas fa-check"></i> 应用到编辑器
                </button>
              </template>
              <template v-else>{{ msg.content }}</template>
            </div>
          </div>
          <div v-if="aiDrawChatLoading" class="ai-draw-chat-message assistant">
            <div class="ai-draw-message-content">
              <i class="fas fa-spinner fa-spin"></i> 思考中...
            </div>
          </div>
        </div>
        <div class="ai-draw-chat-input">
          <textarea v-model="aiDrawChatInput" placeholder="描述你想要的图表..."
            @keydown.enter.exact.prevent="aiDrawSendMessage()" rows="2"></textarea>
          <button class="btn btn-primary" @click="aiDrawSendMessage()"
            :disabled="!aiDrawChatInput.trim() || aiDrawChatLoading">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Draw.io 编辑器 -->
    <div v-else-if="aiDrawCurrentProject?.engine_type === 'drawio'" class="ai-draw-editor-container">
      <iframe ref="drawioFrame" :src="aiDrawDrawioUrl" frameborder="0" class="drawio-iframe"
        @load="aiDrawOnDrawioLoad"></iframe>
    </div>
  </div>

  <!-- ==================== 设置 ==================== -->
  <div v-show="aiDrawCurrentTab === 'settings'" class="sub-tab-content quick-fade-in">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-cog" style="margin-right: 8px"></i>模块设置</div>
      </div>

      <div class="totp-settings-content">
        <!-- 统计信息 -->
        <div class="settings-stats">
          <div class="stat-item">
            <span class="stat-value">{{ aiDrawProjects.length }}</span>
            <span class="stat-label">个项目</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ aiDrawProjects.filter(p => p.engine_type === 'mermaid').length }}</span>
            <span class="stat-label">Mermaid</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ aiDrawProjects.filter(p => p.engine_type === 'drawio').length }}</span>
            <span class="stat-label">Draw.io</span>
          </div>
        </div>

        <div class="settings-divider"></div>

        <!-- AI Provider 配置提示 -->
        <div class="setting-item" style="display: block">
          <div class="setting-text" style="margin-bottom: 12px">
            <span class="setting-title"><i class="fas fa-robot" style="color: var(--current-primary)"></i> AI
              辅助功能</span>
            <span class="setting-desc">AI Draw 复用 AI Chat 模块的 LLM Provider，请前往 AI Chat 模块配置。</span>
          </div>
          <button class="btn btn-secondary" @click="mainActiveTab = 'ai-chat'">
            <i class="fas fa-arrow-right"></i> 前往配置
          </button>
        </div>

        <div class="settings-divider"></div>

        <!-- 操作按钮 -->
        <div style="display: flex; gap: 12px; flex-wrap: wrap">
          <button class="btn btn-secondary" @click="aiDrawLoadProjects">
            <i class="fas fa-sync-alt"></i> 刷新项目列表
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 点击外部关闭下拉菜单 -->
<Teleport to="body">
  <div v-if="aiDrawShowCreateMenu" class="popover-overlay" @click="aiDrawShowCreateMenu = false"
    style="position: fixed; inset: 0; z-index: 99"></div>
</Teleport>