<!-- ==================== Ëá™Âª∫ÊúçÂä°Ê®°Âùó (Self-H) ==================== -->
<div v-show="mainActiveTab === 'self-h'" class="tab-content self-h-tab-content theme-self-h"
    :class="getTabAnimationClass('self-h')">

    <!-- ‰∫åÁ∫ßÂØºËà™Ê†è -->
    <div class="sec-tabs server-sec-tabs">
        <div class="server-tabs-scroll-wrapper">
            <button class="tab-btn" :class="{ active: openListSubTab === 'files' }" @click="openListSubTab = 'files'">
                <i class="fas fa-folder-open"></i> Êñá‰ª∂ÂàóË°®
            </button>
            <button class="tab-btn" :class="{ active: openListSubTab === 'settings' }"
                @click="openListSubTab = 'settings'">
                <i class="fas fa-cog"></i> ËÆæÁΩÆ
            </button>
            <!-- ‰∏¥Êó∂Ê†áÁ≠æÈ°µÂàóË°® -->
            <button v-for="tab in openListTempTabs" :key="tab.id" class="tab-btn temp-tab"
                :class="{ active: openListSubTab === 'temp' && openListActiveTempTabId === tab.id }"
                @click="handleTabTap(tab.id)" @auxclick.middle.stop="closeOpenListTempTab(tab.id)"
                :title="tab.name + ' (ÂèåÂáªÂÖ≥Èó≠)'">
                <i :class="tab.icon || 'fas fa-file'"></i> <span>{{ tab.name }}</span>
            </button>
        </div>
    </div>

    <!-- ÂÜÖÂÆπÂå∫Âüü -->
    <div class="sub-tab-content quick-fade-in">

        <!-- 1. Êñá‰ª∂ÂàóË°® -->
        <div v-if="openListSubTab === 'files'" class="openlist-files-layout">
            <div v-if="!currentOpenListAccount" class="empty-state" style="margin-top: 40px;">
                <div class="empty-icon"><i class="fas fa-plug"></i></div>
                <p>Â∞öÊú™ËøûÊé• OpenList ÂÆû‰æã</p>
                <button class="btn btn-primary" @click="openListSubTab = 'settings'">
                    <i class="fas fa-plus"></i> ÂâçÂæÄÈÖçÁΩÆ
                </button>
            </div>

            <div v-else class="openlist-main-view">
                <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è (Header Area) -->
                <div class="openlist-toolbar-standalone">
                    <div class="toolbar-left">
                        <!-- Ë¥¶Âè∑ÂàáÊç¢ -->
                        <div class="account-pill" v-if="openListAccounts.length > 1">
                            <select :value="currentOpenListAccount?.id"
                                @change="e => selectOpenListAccountById(e.target.value)">
                                <option v-for="acc in openListAccounts" :key="acc.id" :value="acc.id">{{ acc.name }}
                                </option>
                            </select>
                            <i class="fas fa-caret-down"></i>
                        </div>

                        <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
                        <div class="breadcrumb-fluid-container">
                            <button class="bc-node" @click="loadOpenListFiles('/')"><i class="fas fa-home"></i></button>
                            <template v-for="(part, index) in openListPathParts" :key="part.path">
                                <i class="fas fa-chevron-right bc-divider"></i>
                                <button class="bc-node" :class="{ 'active': index === openListPathParts.length - 1 }"
                                    @click="loadOpenListFiles(part.path)">
                                    {{ part.name }}
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Âè≥‰æßÊêúÁ¥¢ -->
                    <div class="toolbar-right">
                        <button class="btn btn-icon-refined" @click="mkdirOpenList" title="Êñ∞Âª∫Êñá‰ª∂Â§π"><i
                                class="fas fa-folder-plus"></i></button>
                        <button class="btn btn-icon-refined" @click="loadOpenListFiles(openListPath, true)"
                            title="Âà∑Êñ∞"><i class="fas fa-sync-alt"
                                :class="{ 'fa-spin': openListFilesLoading }"></i></button>
                    </div>
                </div>

                <!-- Êñá‰ª∂ÂàóË°®Âå∫Âüü (Scrolling Area) -->
                <div class="openlist-list-container">
                    <table class="data-table sticky-header" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="col-name" @click="toggleOpenListSort('name')">ÂêçÁß∞ <i
                                        v-if="openListSortKey === 'name'" class="fas"
                                        :class="openListSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i></th>
                                <th class="col-size" @click="toggleOpenListSort('size')">Â§ßÂ∞è <i
                                        v-if="openListSortKey === 'size'" class="fas"
                                        :class="openListSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i></th>
                                <th class="col-time hide-on-mobile" @click="toggleOpenListSort('modified')">‰øÆÊîπÊó∂Èó¥ <i
                                        v-if="openListSortKey === 'modified'" class="fas"
                                        :class="openListSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i></th>
                            </tr>
                        </thead>
                        <tbody v-if="sortedOpenListFiles.length > 0">
                            <tr v-for="file in sortedOpenListFiles" :key="file.name" @click="handleOpenFile(file)"
                                @contextmenu="showFileContextMenu($event, file, openListPath)"
                                @touchstart="handleFileTouchStart($event, file, openListPath)"
                                @touchend="handleFileTouchEnd($event)" @touchmove="handleFileTouchMove()"
                                @auxclick.middle.stop="handleMiddleClickItem(file)">
                                <td class="col-name">
                                    <div class="file-cell-main">
                                        <div class="file-icon-wrapper">
                                            <img v-if="getFileThumbnail(file)" :src="getFileThumbnail(file)"
                                                class="file-thumb-icon" referrerpolicy="no-referrer" loading="lazy"
                                                @mouseenter="showHoverPreview($event, getFileThumbnail(file))"
                                                @mousemove="moveHoverPreview($event)" @mouseleave="hideHoverPreview"
                                                @touchstart.stop="showHoverPreview($event, getFileThumbnail(file))"
                                                @touchend.stop="hideHoverPreview" />
                                            <i v-else :class="getFileIconClass(file)"></i>
                                        </div>
                                        <span class="file-name-text" :title="file.name">{{ file.name }}</span>
                                    </div>
                                </td>
                                <td class="col-size font-mono text-secondary">{{ getOpenListFileSize(file) || '-' }}
                                </td>
                                <td class="col-time text-tertiary hide-on-mobile">{{ formatDateTime(file.modified) }}
                                </td>
                            </tr>
                        </tbody>
                        <!-- Á©∫Áä∂ÊÄÅ -->
                        <tbody v-else-if="!openListFilesLoading">
                            <tr>
                                <td colspan="3" style="border: none;">
                                    <div class="openlist-empty-state">
                                        <i class="fas fa-folder-open"></i>
                                        <p>ÂΩìÂâçÁõÆÂΩï‰∏∫Á©∫</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Âä†ËΩΩÈ™®Êû∂ -->
                    <div v-if="openListFilesLoading" class="list-loading-shimmer">
                        <div v-for="i in 10" :key="i" class="shimmer-row"></div>
                    </div>

                    <!-- README -->
                    <div v-if="openListReadme" class="readme-footer">
                        <div class="readme-label"><i class="fab fa-markdown"></i> README</div>
                        <div class="markdown-body" v-html="renderMarkdown(openListReadme)"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- 2. ËÆæÁΩÆ -->
        <div v-if="openListSubTab === 'settings'" class="openlist-settings animate-fade-in">
            <div class="panel shadow-sm" style="margin-bottom: 16px;">
                <div class="panel-header" style="padding: 10px;">
                    <div class="panel-title"><i class="fas fa-server text-primary"></i> ÂÆû‰æãÁÆ°ÁêÜ</div>
                </div>
                <div style="padding: 0;">
                    <div v-for="acc in openListAccounts" :key="acc.id" class="setting-item"
                        style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); gap: 12px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span :class="['status-dot', acc.status === 'online' ? 'online' : 'offline']"></span>
                                <span style="font-weight: 600; color: var(--text-primary); font-size: 14px;">{{ acc.name
                                    }}</span>
                            </div>
                            <div
                                style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ acc.api_url }}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-icon-refined sm" @click="selectOpenListAccount(acc)" title="‰ΩøÁî®Ê≠§ÂÆû‰æã"><i
                                    class="fas fa-check"></i></button>
                            <button class="btn btn-icon-refined sm" @click="testOpenListAccount(acc.id)" title="ËøûÊé•ÊµãËØï"><i
                                    class="fas fa-plug"></i></button>
                            <button class="btn btn-icon-refined sm" style="color: var(--danger-color);"
                                @click="deleteOpenListAccount(acc.id)" title="Âà†Èô§"><i
                                    class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="setting-item" style="padding: 10px;">
                        <div
                            style="font-weight: 600; color: var(--text-primary); font-size: 14px; margin-bottom: 12px;">
                            <i class="fas fa-plus-circle text-primary" style="margin-right: 6px;"></i> Ê∑ªÂä†Êñ∞ÂÆû‰æã
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <input type="text" v-model="newOpenListAcc.name" class="form-input" placeholder="ÂêçÁß∞"
                                style="flex: 1; min-width: 100px;" />
                            <input type="text" v-model="newOpenListAcc.api_url" class="form-input" placeholder="API Âú∞ÂùÄ"
                                style="flex: 2; min-width: 200px;" />
                            <input type="password" v-model="newOpenListAcc.api_token" class="form-input"
                                placeholder="Token" style="flex: 1; min-width: 120px;" />
                            <button class="btn btn-primary" @click="doAddOpenListAccount"><i class="fas fa-check"></i>
                                ‰øùÂ≠ò</button>
                        </div>
                    </div>
                    <div v-if="openListAccounts.length === 0" class="setting-item"
                        style="padding: 10px; text-align: center;">
                        <div style="color: var(--text-tertiary); font-size: 13px;"><i class="fas fa-info-circle"></i>
                            ÊöÇÊó†ÈÖçÁΩÆ</div>
                    </div>
                </div>
            </div>
            <div class="panel shadow-sm">
                <div class="panel-header" style="padding: 10px;">
                    <div class="panel-title"><i class="fas fa-sliders-h text-primary"></i> ÂÅèÂ•ΩËÆæÁΩÆ</div>
                </div>
                <div style="padding: 0;">
                    <div class="setting-item"
                        style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                        <div style="flex:1;">
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Ëá™Âä®Âà∑Êñ∞ÁõÆÂΩï</div>
                        </div>
                        <label class="switch"><input type="checkbox" disabled checked><span
                                class="slider round"></span></label>
                    </div>
                    <div class="setting-item"
                        style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;">
                        <input type="range" class="form-range" min="300" max="1200" step="50"
                            v-model="openListPreviewSize" style="width: 120px;">
                        <button class="btn btn-secondary btn-sm" @click="saveOpenListPreviewSize">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. ‰∏¥Êó∂Ê†áÁ≠æÈ°µ -->
        <div v-for="tab in openListTempTabs" :key="tab.id"
            v-show="openListSubTab === 'temp' && tab.id === openListActiveTempTabId"
            class="openlist-files-layout animate-fade-in" :class="{ 'video-mode-layout': tab.isVideo }">
            <!-- ËßÜÈ¢ëÊí≠ÊîæÊ®°Âºè -->
            <div v-if="tab.isVideo" class="openlist-video-tab-view">
                <div class="stream-player-container inside-tab"
                    :class="{ 'controls-visible': streamPlayer.showControls || streamPlayer.loading }">
                    <!-- È°∂Ê†è (‰ªÖÂÖ®Â±èÊàñÁâπÊÆäÈúÄË¶ÅÊó∂ÊòæÁ§∫ÔºåËøôÈáåÊàë‰ª¨ÂèØ‰ª•‰øùÁïôÊàñÊòæÁ§∫Êñá‰ª∂Âêç) -->
                    <div class="stream-player-header">
                        <div class="stream-player-title">
                            <i class="fas fa-film"></i>
                            <span>{{ tab.name }}</span>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-icon-refined" @click="openExternalPlayer"
                                title="Â§ñÈÉ®Êí≠Êîæ (PC: PotPlayer / ÊâãÊú∫: UCÊµèËßàÂô®)">
                                <i class="fas fa-play-circle"></i>
                            </button>
                            <button class="btn btn-icon-refined" @click="openVideoInNewTab" title="Âú®ÊµèËßàÂô®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            <button class="btn btn-icon-refined" @click="closeOpenListTempTab(tab.id)" title="ÂÖ≥Èó≠Ê†áÁ≠æÈ°µ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ËßÜÈ¢ëÊ†∏ÂøÉÂå∫Âüü -->
                    <div class="stream-player-video-wrapper" @mousemove="handleVideoMouseMove" @click="handleVideoClick"
                        @touchstart.prevent="handleVideoClick">
                        <video :id="'video-player-' + tab.id" class="stream-player-video" playsinline
                            preload="auto"></video>

                        <!-- Âä†ËΩΩ‰∏≠ -->
                        <div v-if="streamPlayer.loading" class="stream-player-loading">
                            <div class="stream-player-spinner"></div>
                        </div>

                        <!-- Âø´Êç∑Êìç‰ΩúÊèêÁ§∫ -->
                        <div v-if="streamPlayer.animationType" class="stream-player-speed-tip">
                            <div class="speed-tip-badge">
                                <i v-if="streamPlayer.animationType === 'speed2x'" class="fas fa-bolt"></i>
                                <i v-if="streamPlayer.animationType === 'seek'" class="fas fa-search"></i>
                                {{ streamPlayer.animationType === 'speed2x' ? '2.0X üöÄ' : streamPlayer.animationText }}
                            </div>
                        </div>
                    </div>

                    <!-- ÊéßÂà∂Ê†è -->
                    <div class="stream-player-controls">
                        <!-- ËøõÂ∫¶Êù° -->
                        <div class="stream-player-progress" @mousedown="handleProgressMouseDown"
                            @touchstart.prevent="handleProgressMouseDown">
                            <div class="stream-player-progress-buffered" :style="{ width: getBufferedPercent() + '%' }">
                            </div>
                            <div class="stream-player-progress-played" :style="{ width: getPlayedPercent() + '%' }">
                            </div>
                            <div class="stream-player-progress-thumb" :style="{ left: getPlayedPercent() + '%' }"></div>
                        </div>

                        <div class="stream-player-controls-row">
                            <div class="stream-player-controls-left">
                                <button class="stream-player-btn" @click.stop="toggleVideoPlay">
                                    <i class="fas" :class="streamPlayer.playing ? 'fa-pause' : 'fa-play'"></i>
                                </button>
                                <button class="stream-player-btn" @click.stop="skipVideo(-10)"><i
                                        class="fas fa-backward"></i></button>
                                <button class="stream-player-btn" @click.stop="skipVideo(10)"><i
                                        class="fas fa-forward"></i></button>

                                <div class="stream-player-volume">
                                    <button class="stream-player-btn" @click.stop="toggleMute">
                                        <i class="fas" :class="getVolumeIcon()"></i>
                                    </button>
                                    <div class="stream-player-volume-slider" @mousedown="handleVolumeMouseDown">
                                        <div class="stream-player-volume-level"
                                            :style="{ width: (streamPlayer.muted ? 0 : streamPlayer.volume * 100) + '%' }">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="stream-player-controls-center">
                                <div class="stream-player-time">
                                    {{ formatVideoTime(streamPlayer.currentTime) }} / {{
                                    formatVideoTime(streamPlayer.duration) }}
                                </div>
                            </div>

                            <div class="stream-player-controls-right">
                                <div class="stream-player-speed">
                                    <button class="stream-player-btn">{{ streamPlayer.playbackRate }}x</button>
                                    <div class="stream-player-speed-menu">
                                        <div v-for="rate in streamPlayer.playbackRates" :key="rate"
                                            class="stream-player-speed-option"
                                            :class="{ active: streamPlayer.playbackRate === rate }"
                                            @click.stop="setVideoPlaybackRate(rate)">
                                            {{ rate }}x
                                        </div>
                                    </div>
                                </div>
                                <button class="stream-player-btn" @click.stop="toggleVideoPiP"><i
                                        class="fas fa-external-link-square-alt"></i></button>
                                <button class="stream-player-btn" @click.stop="toggleVideoFullscreen"><i
                                        class="fas fa-expand"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÊôÆÈÄöÊñá‰ª∂ÂàóË°®Ê®°Âºè -->
            <div v-else class="openlist-main-view">
                <div class="openlist-toolbar-standalone">
                    <div class="toolbar-left">
                        <div class="breadcrumb-fluid-container">
                            <button class="bc-node" @click="loadTempTabFiles('/')"><i class="fas fa-home"></i></button>
                            <template v-for="(part, index) in openListTempPathParts" :key="part.path">
                                <i class="fas fa-chevron-right bc-divider"></i>
                                <button class="bc-node"
                                    :class="{ 'active': index === openListTempPathParts.length - 1 }"
                                    @click="loadTempTabFiles(part.path)">{{ part.name }}</button>
                            </template>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn btn-icon-refined" @click="loadTempTabFiles(tab.path, true)"><i
                                class="fas fa-sync-alt"></i></button>
                        <button class="btn btn-secondary btn-sm" @click="mergeToMainTab">
                            <i class="fas fa-layer-group"></i> <span>ÂêàÂπ∂Âà∞‰∏ªÂàóË°®</span>
                        </button>
                    </div>
                </div>
                <div class="openlist-list-container">
                    <table class="data-table sticky-header" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="col-name">ÂêçÁß∞</th>
                                <th class="col-size">Â§ßÂ∞è</th>
                                <th class="col-time hide-on-mobile">‰øÆÊîπÊó∂Èó¥</th>
                            </tr>
                        </thead>
                        <tbody v-if="tab.files.length > 0">
                            <tr v-for="file in tab.files" :key="file.name" @click="handleTempTabFile(file)"
                                @contextmenu="showFileContextMenu($event, file, tab.path)"
                                @touchstart="handleFileTouchStart($event, file, tab.path)"
                                @touchend="handleFileTouchEnd($event)" @touchmove="handleFileTouchMove()"
                                @auxclick.middle.stop="handleMiddleClickItem(file)">
                                <td class="col-name">
                                    <div class="file-cell-main">
                                        <div class="file-icon-wrapper"><i :class="getFileIconClass(file)"></i></div>
                                        <span class="file-name-text">{{ file.name }}</span>
                                    </div>
                                </td>
                                <td class="col-size font-mono text-secondary">{{ getOpenListFileSize(file) || '-' }}
                                </td>
                                <td class="col-time text-tertiary hide-on-mobile">{{ formatDateTime(file.modified) }}
                                </td>
                            </tr>
                        </tbody>
                        <tbody v-else-if="!tab.loading">
                            <tr>
                                <td colspan="3" style="text-align:center; padding: 20px;">ÁõÆÂΩï‰∏∫Á©∫</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÊÇ¨ÂÅúÈ¢ÑËßàÂõæÂÆπÂô® -->
<div id="file-hover-preview" class="file-hover-preview">
    <img id="file-hover-img" src="" referrerpolicy="no-referrer" />
</div>

<!-- Êñá‰ª∂Âè≥ÈîÆËèúÂçï -->
<Teleport to="body">
    <div v-if="openListContextMenu.visible" class="openlist-context-menu"
        :style="{ left: openListContextMenu.x + 'px', top: openListContextMenu.y + 'px' }" @click.stop>
        <div class="context-menu-item" @click="handleFileContextAction('open')">
            <i class="fas fa-folder-open"></i>
            <span>{{ openListContextMenu.file?.is_dir ? 'ÊâìÂºÄ' : 'Êü•ÁúãËØ¶ÊÉÖ' }}</span>
        </div>
        <div v-if="openListContextMenu.file?.is_dir" class="context-menu-item"
            @click="handleFileContextAction('open-new-tab')">
            <i class="fas fa-external-link-alt"></i>
            <span>Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ</span>
        </div>
        <div v-if="!openListContextMenu.file?.is_dir" class="context-menu-item"
            @click="handleFileContextAction('download')">
            <i class="fas fa-download"></i>
            <span>‰∏ãËΩΩ</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" @click="handleFileContextAction('rename')">
            <i class="fas fa-edit"></i>
            <span>ÈáçÂëΩÂêç</span>
        </div>
        <div class="context-menu-item danger" @click="handleFileContextAction('delete')">
            <i class="fas fa-trash-alt"></i>
            <span>Âà†Èô§</span>
        </div>
    </div>
</Teleport>