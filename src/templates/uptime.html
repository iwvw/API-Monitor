<!-- ==================== Uptime 监测部分 (Standard Layout) ==================== -->
<div class="tab-content uptime-tab-content theme-uptime" :class="[getTabAnimationClass('uptime')]">

  <div class="uptime-container">
    <!-- Uptime 顶部导航 (Consistent with other modules) -->
    <div class="sec-tabs">
      <button class="tab-btn" :class="{ active: uptimeCurrentTab === 'list' }" @click="uptimeCurrentTab = 'list'">
        <i class="fas fa-heartbeat"></i> 仪表盘
      </button>
      <button class="tab-btn" :class="{ active: uptimeCurrentTab === 'add' }"
        @click="uptimeCurrentTab = 'add'; initUptimeForm()">
        <i class="fas fa-plus-circle"></i> 添加监测
      </button>
      <button class="tab-btn" :class="{ active: uptimeCurrentTab === 'stats' }" @click="uptimeCurrentTab = 'stats'">
        <i class="fas fa-chart-pie"></i> 统计报表
      </button>
    </div>

    <!-- ========== 监测列表标签页 ========== -->
    <div v-show="uptimeCurrentTab === 'list'" class="sub-tab-content fade-in-up">

      <!-- 统计筛选条 -->
      <div class="uptime-stats-bar-modern">
        <div class="uptime-stat-pill-modern" :class="{ active: uptimeStatusFilter === null }"
          @click="uptimeStatusFilter = null">
          <span class="stat-pill-count">{{ uptimeMonitors.length }}</span>
          <span style="margin-left: 6px;">全部</span>
        </div>
        <div class="uptime-stat-pill-modern up" :class="{ active: uptimeStatusFilter === 'up' }"
          @click="uptimeStatusFilter = 'up'">
          <span class="stat-pill-count">{{ uptimeStats.up }}</span>
          <span style="margin-left: 6px;">正常</span>
        </div>
        <div class="uptime-stat-pill-modern down" :class="{ active: uptimeStatusFilter === 'down' }"
          @click="uptimeStatusFilter = 'down'">
          <span class="stat-pill-count">{{ uptimeStats.down }}</span>
          <span style="margin-left: 6px;">故障</span>
        </div>
        <div class="uptime-stat-pill-modern pending" :class="{ active: uptimeStatusFilter === 'pending' }"
          @click="uptimeStatusFilter = 'pending'">
          <span class="stat-pill-count">{{ uptimeStats.pending }}</span>
          <span style="margin-left: 6px;">等待</span>
        </div>

        <!-- 搜索 -->
        <div class="uptime-search-modern">
          <i class="fas fa-search"></i>
          <input v-model="uptimeSearchText" placeholder="搜索监测目标..." />
        </div>

        <button class="btn btn-secondary btn-sm" @click="loadUptimeMonitors" :disabled="uptimeLoading" title="刷新"
          style="border-radius: 8px; height: 34px; width: 34px; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-sync-alt" :class="{ 'fa-spin': uptimeLoading }"></i>
        </button>
      </div>

      <!-- 列表区域 -->
      <div v-if="uptimeLoading && uptimeMonitors.length === 0" class="loading-state">
        <p style="text-align:center; color: var(--text-tertiary); padding: 40px;">Loading Monitors...</p>
      </div>

      <div v-if="uptimeMonitors.length === 0" class="uptime-empty-state">
        <i class="fas fa-heartbeat"></i>
        <h3 style="margin: 12px 0 6px; font-size: 18px; color: var(--text-primary);">暂无监测目标</h3>
        <p style="margin-bottom: 24px;">添加您的第一个监测目标，实时掌握服务运行状态</p>
        <button class="btn btn-primary" @click="uptimeCurrentTab = 'add'">
          <i class="fas fa-plus"></i> 添加监测
        </button>
      </div>

      <div v-else class="uptime-monitor-list">
        <div v-for="monitor in getFilteredUptimeMonitors()" :key="monitor.id" class="uptime-monitor-card"
          :class="{ expanded: selectedUptimeMonitor && selectedUptimeMonitor.id === monitor.id }">

          <!-- Card Header -->
          <div class="uptime-monitor-header" @click="selectUptimeMonitor(monitor)">

            <!-- Status Icon (Replaced Line) -->
            <div class="monitor-status-icon" :class="[getUptimeStatus(monitor)]">
              <i :class="getUptimeTypeIcon(monitor.type)"></i>
            </div>

            <!-- Main Info -->
            <div class="monitor-main-info">
              <div class="monitor-name-row">
                <span class="monitor-name">{{ monitor.name }}</span>
                <span v-if="!monitor.active" class="meta-badge" style="background: var(--bg-tertiary); opacity: 0.7;">
                  <i class="fas fa-pause-circle"></i> 暂停
                </span>
                <!-- Tags -->
                <div class="monitor-meta-badges">
                  <span v-if="monitor.tags && monitor.tags.length" v-for="tag in monitor.tags" :key="tag"
                    class="meta-badge">{{ tag }}</span>
                </div>
              </div>
              <div class="monitor-url">
                <!-- <i :class="getUptimeTypeIcon(monitor.type)"></i> -->
                <!-- Render Link only for HTTP/Keyword -->
                <a v-if="['http', 'keyword'].includes(monitor.type)" :href="getUptimeDisplayUrl(monitor)"
                  target="_blank" @click.stop>
                  {{ getUptimeDisplayUrl(monitor) }}
                </a>
                <!-- Render Text for others -->
                <span v-else class="monitor-url-text">{{ getUptimeDisplayUrl(monitor) }}</span>
                <span style="font-size: 11px; color: var(--text-tertiary); margin-left: 8px;">• {{ monitor.interval }}s
                  间隔</span>
              </div>
            </div>

            <!-- Right Stats -->
            <div class="monitor-stats-right">
              <div class="stats-row">
                <div class="ping-pill">
                  <i class="fas fa-wifi" style="font-size: 11px;"></i>
                  <span v-if="getLastHeartbeat(monitor.id) && getLastHeartbeat(monitor.id).status === 'up'">
                    {{ getLastHeartbeat(monitor.id).ping }}ms
                  </span>
                  <span v-else style="color: var(--text-tertiary);">Timeout</span>
                </div>
                <div class="uptime-pill-large" :class="getUptimeClass(calculateUptime(monitor.id, 1))">
                  {{ calculateUptime(monitor.id, 1) }}%
                </div>
              </div>
              <!-- Inline Heartbeat -->
              <div class="heartbeat-bar-inline list-view">
                <div v-for="(beat, idx) in getHeartbeatBars(monitor.id, 30)" :key="idx" class="beat-pill"
                  :class="beat.status" @mouseenter="showUptimeTooltip($event, beat)" @mouseleave="hideUptimeTooltip">
                </div>
              </div>
            </div>
          </div>

          <!-- Expanded Details (Always rendered, animated via CSS Grid) -->
          <div class="monitor-details-body">
            <div class="monitor-details-inner">
              <div class="uptime-form-section-title">
                <i class="fas fa-chart-area"></i> 详细数据
                <div style="margin-left: auto; display: flex; gap: 8px;">
                  <button class="btn btn-secondary btn-sm" @click="toggleUptimeMonitor(monitor)">
                    <i :class="monitor.active ? 'fas fa-pause' : 'fas fa-play'"></i> {{ monitor.active ? '暂停' : '恢复' }}
                  </button>
                  <button class="btn btn-secondary btn-sm" @click="editUptimeMonitor(monitor)">
                    <i class="fas fa-edit"></i> 编辑
                  </button>
                  <button class="btn btn-danger-soft btn-sm" @click="deleteUptimeMonitor(monitor.id)"
                    style="color: var(--danger-color);">
                    <i class="fas fa-trash"></i> 删除
                  </button>
                </div>
              </div>

              <div class="detail-grid">
                <div>
                  <!-- Chart Area -->
                  <div style="height: 120px; position: relative; margin-bottom: 12px;">
                    <!-- Charts are always in DOM now, render only when expanded -->
                    <canvas :id="'uptimeDetailChart-' + monitor.id"></canvas>
                  </div>

                  <!-- Long Heartbeat list -->
                  <div class="heartbeat-bar-inline" style="width: 100%; height: 24px; margin-top: 12px;">
                    <div v-for="(beat, idx) in getHeartbeatBars(monitor.id, 60)" :key="idx" class="beat-pill"
                      :class="beat.status" @mouseenter="showUptimeTooltip($event, beat)"
                      @mouseleave="hideUptimeTooltip">
                    </div>
                  </div>
                  <div
                    style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-tertiary); margin-top: 6px; font-family: var(--font-mono);">
                    <span>{{ getHeartbeatTimeLabel(monitor.id, 'start') }}前</span>
                    <span>现在</span>
                  </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                  <div class="form-group-modern"
                    style="margin: 0; padding: 12px; background: var(--bg-primary); border-radius: 12px; border: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">24h 可用率</div>
                    <div
                      style="font-size: 18px; font-weight: 800; color: var(--text-primary); font-family: var(--font-mono);">
                      {{ calculateUptime(monitor.id, 1) }}%</div>
                  </div>
                  <div class="form-group-modern"
                    style="margin: 0; padding: 12px; background: var(--bg-primary); border-radius: 12px; border: 1px solid var(--border-color);">
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">30d 可用率</div>
                    <div
                      style="font-size: 18px; font-weight: 800; color: var(--text-primary); font-family: var(--font-mono);">
                      {{ calculateUptime(monitor.id, 30) }}%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== 添加/编辑表单 ========== -->
    <div v-show="uptimeCurrentTab === 'add'" class="sub-tab-content fade-in-up">
      <div class="uptime-form-card">
        <div class="uptime-form-section-title">
          <i class="fas fa-edit"></i> {{ uptimeForm.id ? '编辑监测目标' : '新建监测目标' }}
        </div>

        <div class="uptime-form-grid">
          <!-- Monitoring Type (Full Width) -->
          <div class="col-span-12 form-group-modern">
            <label class="form-label-modern">监测类型</label>
            <div class="type-selector-grid">
              <div class="type-option" :class="{ active: uptimeForm.type === 'http' }"
                @click="uptimeForm.type = 'http'">
                <i class="fas fa-globe"></i> <span>HTTP(s)</span>
              </div>
              <div class="type-option" :class="{ active: uptimeForm.type === 'keyword' }"
                @click="uptimeForm.type = 'keyword'">
                <i class="fas fa-search"></i> <span>关键词</span>
              </div>
              <div class="type-option" :class="{ active: uptimeForm.type === 'tcp' }" @click="uptimeForm.type = 'tcp'">
                <i class="fas fa-ethernet"></i> <span>TCP Port</span>
              </div>
              <div class="type-option" :class="{ active: uptimeForm.type === 'ping' }"
                @click="uptimeForm.type = 'ping'">
                <i class="fas fa-signal"></i> <span>Ping</span>
              </div>
              <div class="type-option" :class="{ active: uptimeForm.type === 'dns' }" @click="uptimeForm.type = 'dns'">
                <i class="fas fa-server"></i> <span>DNS</span>
              </div>
            </div>
          </div>

          <!-- Basic Info Row: Name (4) + Target (8) -->
          <div class="col-span-4 form-group-modern">
            <label class="form-label-modern">显示名称 <span style="color: var(--danger-color);">*</span></label>
            <input v-model="uptimeForm.name" type="text" class="form-input-modern" placeholder="e.g. Production API" />
          </div>

          <div class="col-span-8 form-group-modern" v-if="['http', 'keyword'].includes(uptimeForm.type)">
            <label class="form-label-modern">URL <span style="color: var(--danger-color);">*</span></label>
            <input v-model="uptimeForm.url" type="text" class="form-input-modern" placeholder="https://example.com" />
          </div>

          <div class="col-span-8 form-group-modern" v-if="['tcp', 'ping', 'dns'].includes(uptimeForm.type)"
            :class="{'col-span-6': uptimeForm.type === 'tcp', 'col-span-8': uptimeForm.type !== 'tcp'}">
            <label class="form-label-modern">Hostname <span style="color: var(--danger-color);">*</span></label>
            <input v-model="uptimeForm.hostname" type="text" class="form-input-modern"
              placeholder="example.com or 1.1.1.1" />
          </div>

          <div class="col-span-2 form-group-modern" v-if="uptimeForm.type === 'tcp'">
            <label class="form-label-modern">Port <span style="color: var(--danger-color);">*</span></label>
            <input v-model.number="uptimeForm.port" type="number" class="form-input-modern" placeholder="80" />
          </div>

          <!-- Settings Row: Interval (6) + Retries (6) -->
          <div class="col-span-6 form-group-modern">
            <label class="form-label-modern">检测频率 (秒)</label>
            <input v-model.number="uptimeForm.interval" type="number" class="form-input-modern" min="20" />
          </div>
          <div class="col-span-6 form-group-modern">
            <label class="form-label-modern">重试次数</label>
            <input v-model.number="uptimeForm.retries" type="number" class="form-input-modern" min="0" />
          </div>

          <!-- Advanced Section -->
          <div class="col-span-12 uptime-form-section-title" style="margin-top: 10px;">
            <i class="fas fa-cogs"></i> 高级设置
          </div>

          <!-- Expiry (6) + SSL (6) -->
          <div class="col-span-6 form-group-modern" v-if="['http'].includes(uptimeForm.type)">
            <label class="form-label-modern">证书过期提醒 (天)</label>
            <input v-model.number="uptimeForm.expiryNotification" type="number" class="form-input-modern"
              placeholder="7" />
          </div>

          <div class="col-span-6 form-group-modern" v-if="['http', 'keyword'].includes(uptimeForm.type)"
            style="display:flex; align-items: flex-end;">
            <label class="form-switch">
              <input type="checkbox" v-model="uptimeForm.ignoreTls" />
              <span class="switch-track">
                <span class="switch-knob"></span>
              </span>
              <span class="switch-label">忽略 TLS</span>
            </label>
          </div>

          <!-- 告警通知 Section -->
          <div class="col-span-12 uptime-form-section-title" style="margin-top: 10px;">
            <i class="fas fa-bell"></i> 告警通知
          </div>

          <div class="col-span-12 form-group-modern">
            <label class="form-label-modern">通知渠道 <span
                style="color: var(--text-tertiary); font-weight: 400;">(故障时接收通知)</span></label>
            <div class="checkbox-group"
              style="display: flex; flex-wrap: wrap; gap: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
              <template v-for="channel in notificationChannels" :key="channel.id">
                <label v-if="channel && (channel.enabled === true || channel.enabled === 1)" class="form-switch"
                  style="margin: 0;">
                  <input type="checkbox" :value="channel.id" v-model="uptimeForm.notificationChannels">
                  <span class="switch-track">
                    <span class="switch-knob"></span>
                  </span>
                  <span class="switch-label" style="display: flex; align-items: center; gap: 6px;">
                    <i :class="channel.type === 'email' ? 'fas fa-envelope' : 'fab fa-telegram'"
                      style="opacity: 0.7;"></i>
                    {{ channel.name }}
                  </span>
                </label>
              </template>
              <span
                v-if="!notificationChannels || notificationChannels.filter(c => c.enabled === true || c.enabled === 1).length === 0"
                style="color: var(--text-tertiary); font-size: 13px;">
                <i class="fas fa-info-circle"></i> 暂无可用通知渠道，请先在 <a href="#"
                  @click.prevent="mainActiveTab = 'notification'" style="color: var(--primary-color);">工具箱 → 通知渠道</a>
                中添加
              </span>
            </div>
          </div>

          <!-- Tags: Span 12 or remaining -->
          <div class="col-span-12 form-group-modern">
            <label class="form-label-modern">标签 (Tags)</label>
            <input v-model="uptimeForm.tagsInput" type="text" class="form-input-modern"
              placeholder="prod, api, server (逗号分隔)" />
          </div>
        </div>

        <!-- Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 10px;">
          <button class="btn btn-secondary" @click="uptimeCurrentTab = 'list'">取消</button>
          <button class="btn btn-primary" @click="saveUptimeMonitor" :disabled="uptimeSaving">
            <i class="fas" :class="uptimeSaving ? 'fa-spinner fa-spin' : 'fa-save'"></i> 保存
          </button>
        </div>

      </div>
    </div>

    <!-- Stats Tab (Placeholder) -->
    <div v-show="uptimeCurrentTab === 'stats'" class="sub-tab-content fade-in-up">
      <div class="uptime-empty-state">
        <i class="fas fa-chart-pie"></i>
        <h3>统计报表</h3>
        <p>更多详细统计功能开发中...</p>
      </div>
    </div>

  </div>
</div>

<!-- Uptime Tooltip Container -->
<div id="uptime-tooltip" class="uptime-tooltip">
  <div class="uptime-tooltip-time"></div>
  <div class="uptime-tooltip-status">
    <span class="dot"></span>
    <span class="status-text"></span>
  </div>
  <div class="uptime-tooltip-ping"></div>
</div>