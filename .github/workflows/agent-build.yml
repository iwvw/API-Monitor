# ===================================
# API Monitor Go Agent Build CI/CD
# ===================================
# è§¦å‘æ¡ä»¶ï¼š
# - æ¨é€åˆ° main åˆ†æ”¯ï¼ˆagent-go ç›®å½•æœ‰å˜æ›´ï¼‰
# - åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰
# - æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰

name: Build Go Agent

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - 'agent-go/**'
      - '.github/workflows/agent-build.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Agent ç‰ˆæœ¬å·'
        required: false
        default: '2.0.0'

permissions:
  contents: write

env:
  GO_VERSION: '1.21'

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: ''
          - goos: linux
            goarch: arm64
            suffix: ''
          - goos: windows
            goarch: amd64
            suffix: '.exe'
          - goos: darwin
            goarch: amd64
            suffix: ''
          - goos: darwin
            goarch: arm64
            suffix: ''

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # è®¾ç½® Go ç¯å¢ƒ
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: agent-go/go.sum

      # è·å–ç‰ˆæœ¬å·
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=2.0.0-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      # æ„å»º Agent
      - name: Build Agent
        working-directory: agent-go
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          OUTPUT_NAME="agent-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }}"
          # Windows ä½¿ç”¨ -H windowsgui éšè—æ§åˆ¶å°çª—å£
          if [ "${{ matrix.goos }}" = "windows" ]; then
            go build -ldflags="-s -w -H windowsgui -X main.VERSION=${{ steps.version.outputs.version }}" -o "../dist/${OUTPUT_NAME}"
          else
            go build -ldflags="-s -w -X main.VERSION=${{ steps.version.outputs.version }}" -o "../dist/${OUTPUT_NAME}"
          fi
          echo "Built: ${OUTPUT_NAME}"

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/agent-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }}
          retention-days: 30

  # åˆ›å»º Releaseï¼ˆä»…åœ¨ tag æ¨é€æ—¶ï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## API Monitor Agent v${{ github.ref_name }}

            ### ä¸‹è½½

            | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
            |------|------|------|
            | Linux | amd64 | `agent-linux-amd64` |
            | Linux | arm64 | `agent-linux-arm64` |
            | Windows | amd64 | `agent-windows-amd64.exe` |
            | macOS | amd64 | `agent-darwin-amd64` |
            | macOS | arm64 | `agent-darwin-arm64` |

            ### ä½¿ç”¨æ–¹æ³•

            ```bash
            # ä¸‹è½½
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/agent-linux-amd64
            chmod +x agent-linux-amd64

            # è¿è¡Œ
            ./agent-linux-amd64 --id <SERVER_ID> -k <AGENT_KEY> -s <SERVER_URL>
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # è¾“å‡ºæ„å»ºæ‘˜è¦
  summary:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Build Summary
        run: |
          echo "## ğŸš€ Go Agent æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ„å»ºå¹³å°" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | æ¶æ„ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "- åœ¨ Actions é¡µé¢ä¸‹è½½æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- æˆ–åˆ›å»º Release è‡ªåŠ¨å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
