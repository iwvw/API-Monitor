# ===================================
# API Monitor Docker Image CI/CD
# ===================================
# è§¦å‘æ¡ä»¶ï¼š
# - æ¨é€åˆ° main åˆ†æ”¯ â†’ latest æ ‡ç­¾
# - æ¨é€åˆ°å…¶ä»–åˆ†æ”¯ â†’ dev æ ‡ç­¾
# - åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰
# - æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
#
# æ„å»ºç­–ç•¥ï¼š
# - amd64 å’Œ arm64 åˆ†åˆ«åœ¨åŸç”Ÿ runner ä¸Šæ„å»ºï¼ˆé¿å… QEMU é—®é¢˜ï¼‰
# - ä½¿ç”¨ docker manifest åˆå¹¶å¤šæ¶æ„é•œåƒ

name: Build and Publish Docker Image

on:
  push:
    branches: ["**"] # æ‰€æœ‰åˆ†æ”¯
    tags: ["v*"]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  workflow_dispatch:
    inputs:
      tag:
        description: "é•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: "latest"
      platforms:
        description: "æ„å»ºå¹³å°ï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼‰"
        required: false
        default: "linux/amd64,linux/arm64"

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: api-monitor
  REGISTRY: ghcr.io
  DOCKERHUB_REPO: ${{ github.repository_owner }}/api-monitor

jobs:
  # ==========================================
  # é˜¶æ®µ 1: åˆ†æ¶æ„æ„å»ºï¼ˆåŸç”Ÿ runnerï¼Œé¿å… QEMUï¼‰
  # ==========================================
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
            suffix: amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            suffix: arm64

    runs-on: ${{ matrix.runner }}
    outputs:
      tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æå–å…ƒæ•°æ®ï¼ˆç”¨äºç”Ÿæˆæ ‡ç­¾ï¼‰
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
            ${{ env.DOCKERHUB_REPO }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=dev,enable=${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/v') }}
            type=ref,event=branch,enable=${{ github.ref != 'refs/heads/main' }}
            type=sha,prefix=,enable=${{ github.ref == 'refs/heads/main' }}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag != '' }}
          labels: |
            org.opencontainers.image.title=API Monitor
            org.opencontainers.image.description=APIèšåˆç›‘æ§é¢æ¿
            org.opencontainers.image.vendor=iwvw
            maintainer=iwvw

      # æ„å»ºå¹¶æ¨é€å•æ¶æ„é•œåƒï¼ˆå¸¦åç¼€ï¼‰
      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ matrix.platform }}
          no-cache: true
          push: true
          # åŒæ—¶æ¨é€åˆ°ä¸¤ä¸ª Registry çš„ä¸´æ—¶æ¶æ„æ ‡ç­¾ï¼Œç¡®ä¿å±‚å·²å°±ç»ªï¼Œé¿å…åˆå¹¶æ—¶è·¨ Registry å¤åˆ¶å±‚
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:build-${{ github.run_id }}-${{ matrix.suffix }}
            ${{ (github.event_name != 'pull_request' && secrets.DOCKERHUB_TOKEN != '') && format('{0}:build-{1}-{2}', env.DOCKERHUB_REPO, github.run_id, matrix.suffix) || '' }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}
          build-args: |
            NODE_ENV=production

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          echo "${{ steps.build.outputs.digest }}" > /tmp/digests/${{ matrix.suffix }}

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.suffix }}
          path: /tmp/digests/*
          retention-days: 1

  # ==========================================
  # é˜¶æ®µ 2: åˆå¹¶å¤šæ¶æ„ manifest
  # ==========================================
  merge:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
            ${{ env.DOCKERHUB_REPO }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=dev,enable=${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/v') }}
            type=ref,event=branch,enable=${{ github.ref != 'refs/heads/main' }}
            type=sha,prefix=,enable=${{ github.ref == 'refs/heads/main' }}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag != '' }}

      # åˆ›å»ºå¹¶æ¨é€å¤šæ¶æ„ manifest
      - name: Create and push manifest
        run: |
          # è¯»å–å„æ¶æ„ digest
          AMD64_DIGEST=$(cat /tmp/digests/amd64)
          ARM64_DIGEST=$(cat /tmp/digests/arm64)
          
          echo "AMD64 Digest: $AMD64_DIGEST"
          echo "ARM64 Digest: $ARM64_DIGEST"
          
          # ä¸ºæ¯ä¸ªç›®æ ‡æ ‡ç­¾åˆ›å»º manifest
          TAGS="${{ steps.meta.outputs.tags }}"
          echo "$TAGS" | while IFS= read -r TAG; do
            [ -z "$TAG" ] && continue
            
            # ç¡®å®šå½“å‰æ ‡ç­¾æ‰€å±çš„ Registry ä»¥é€‰æ‹©åŒæºçš„æºé•œåƒè¿›è¡Œåˆå¹¶ï¼ˆé¿å…è·¨ Registry å¤åˆ¶ Blob å¯¼è‡´ 400 é”™è¯¯ï¼‰
            if [[ "$TAG" == "${{ env.REGISTRY }}"* ]]; then
               SRC_PREFIX="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
            else
               SRC_PREFIX="${{ env.DOCKERHUB_REPO }}"
            fi
            
            echo "Creating manifest for: $TAG using source: $SRC_PREFIX"
            
            # å¢åŠ é‡è¯•æœºåˆ¶ï¼Œåº”å¯¹ Registry æç«¯æƒ…å†µä¸‹çš„æŠ–åŠ¨
            for i in {1..3}; do
              docker buildx imagetools create -t "$TAG" \
                "${SRC_PREFIX}@${AMD64_DIGEST}" \
                "${SRC_PREFIX}@${ARM64_DIGEST}" && break || {
                if [ $i -lt 3 ]; then
                  echo "Push failed, retrying in 10s ($i/3)..."
                  sleep 10
                else
                  echo "Failed to create manifest for $TAG after 3 attempts."
                  exit 1
                fi
              }
            done
          done

      - name: Image digest
        run: |
          echo "## ğŸ³ Docker é•œåƒæ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾ï¼š**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ”¯æŒæ¶æ„ï¼š** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‹‰å–å‘½ä»¤ï¼š**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# ä» GHCR æ‹‰å–" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# ä» Docker Hub æ‹‰å–" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKERHUB_REPO }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # é˜¶æ®µ 3: æ¸…ç†ä¸´æ—¶é•œåƒï¼ˆå¯é€‰ï¼‰
  # ==========================================
  cleanup:
    runs-on: ubuntu-latest
    needs: merge
    if: always()
    continue-on-error: true

    steps:
      - name: Delete temporary build images
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ env.IMAGE_NAME }}
          package-type: container
          min-versions-to-keep: 0
          delete-only-untagged-versions: false
          # åªåˆ é™¤ä¸´æ—¶æ„å»ºæ ‡ç­¾
          ignore-versions: "^(?!build-${{ github.run_id }}).*$"
        continue-on-error: true

  # ==========================================
  # é˜¶æ®µ 4: å®‰å…¨æ‰«æï¼ˆå¯é€‰ï¼‰
  # ==========================================
  security-scan:
    runs-on: ubuntu-latest
    needs: merge
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    continue-on-error: true

    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
